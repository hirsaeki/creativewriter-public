name: Sync fork with upstream

on:
  schedule:
    - cron: "0 18 * * *" # UTC。JSTだと毎日03:00
  workflow_dispatch:

permissions:
  contents: write

env:
  # 任意: "owner/repo" を直書きすると upstream 自動判別より優先
  UPSTREAM: ""

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Git identity
        # Ensure git has a valid committer before any merges/pushes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Detect upstream
        id: detect
        env:
          GITHUB_TOKEN: ${{ github.token }}
          OVERRIDE_UPSTREAM: ${{ env.UPSTREAM }}
          FORK_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          if [ -n "$OVERRIDE_UPSTREAM" ]; then
            echo "upstream=$OVERRIDE_UPSTREAM" >> "$GITHUB_OUTPUT"
            echo "branch=$FORK_DEFAULT_BRANCH" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          repo="${GITHUB_REPOSITORY}"
          json=$(curl -s \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${repo}")

          upstream=$(echo "$json" | jq -r '.parent.full_name // empty')
          upstream_branch=$(echo "$json" | jq -r '.parent.default_branch // empty')

          if [ -z "$upstream" ] || [ "$upstream" = "null" ]; then
            echo "This repo does not look like a fork (no parent)."
            exit 0
          fi

          if [ -z "$upstream_branch" ] || [ "$upstream_branch" = "null" ]; then
            upstream_branch="$FORK_DEFAULT_BRANCH"
          fi

          echo "upstream=$upstream" >> "$GITHUB_OUTPUT"
          echo "branch=$upstream_branch" >> "$GITHUB_OUTPUT"

      - name: Sync (merge; fail on conflict)
        if: steps.detect.outputs.upstream != ''
        env:
          UPSTREAM_REPO: ${{ steps.detect.outputs.upstream }}
          TARGET_BRANCH: ${{ steps.detect.outputs.branch }}
        run: |
          set -euo pipefail
          
          git config --local user.name  "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git remote add upstream "https://github.com/${UPSTREAM_REPO}.git" || true
          git fetch upstream "$TARGET_BRANCH"
          git checkout "$TARGET_BRANCH"
          
          # .gitattributes の merge=ours を有効化
          git config --local merge.ours.driver true
          
          # まずFF
          if git merge --ff-only "upstream/${TARGET_BRANCH}"; then
            echo "Fast-forwarded."
          else
            # 分岐してたら merge commit
            if git merge --no-ff --no-edit "upstream/${TARGET_BRANCH}"; then
              echo "Merge succeeded."
            else
              echo "Merge conflict. Auto-resolving merge=ours paths..."
          
              # 未解決パス
              CONFLICTS="$(git ls-files -u | awk '{print $4}' | sort -u || true)"
              echo "$CONFLICTS"
          
              while IFS= read -r path; do
                [ -z "$path" ] && continue
                attr="$(git check-attr merge -- "$path" | awk -F': ' '{print $3}')"
                if [ "$attr" = "ours" ]; then
                  echo "Resolve with ours: $path"
                  if git checkout --ours -- "$path" 2>/dev/null; then
                    git add -- "$path"
                  else
                    git rm -f -- "$path" >/dev/null 2>&1 || true
                  fi
                fi
              done <<< "$CONFLICTS"
          
              # まだ残る競合は落とす（安全）
              REMAINING="$(git ls-files -u | awk '{print $4}' | sort -u || true)"
              if [ -n "$REMAINING" ]; then
                echo "Remaining conflicts:"
                echo "$REMAINING"
                exit 1
              fi
          
              git commit -m "Merge upstream/${TARGET_BRANCH} (auto-resolve merge=ours)"
            fi
          fi
          
          git push origin "$TARGET_BRANCH"
