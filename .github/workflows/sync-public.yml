name: Sync to Public Repository

on:
  push:
    branches: [release]  # Only sync on release branch pushes
  workflow_dispatch: # Allow manual trigger

jobs:
  # Deploy Cloudflare Worker backend to production environment
  deploy-backend-production:
    name: Deploy Backend (Production)
    runs-on: ubuntu-latest
    if: github.repository == 'MarcoDroll/creativewriter2'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies and deploy
        working-directory: ./backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ðŸ“¦ Installing backend dependencies..."
          npm install
          echo "ðŸš€ Deploying backend to production environment..."
          npx wrangler deploy
          echo "âœ… Backend deployed to production environment"

  sync-public:
    runs-on: ubuntu-latest
    if: github.repository == 'MarcoDroll/creativewriter2' # Only run on private repo
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit_hash: ${{ steps.version.outputs.commit_hash }}
      commit_message: ${{ steps.version.outputs.commit_message }}
      build_date: ${{ steps.version.outputs.build_date }}
    
    steps:
      - name: Checkout private repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Get full history
          token: ${{ secrets.PUBLIC_REPO_TOKEN }}

      - name: Setup Git and sync to public repository
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          echo "Syncing release branch to public repository..."
          git remote add public https://x-access-token:${GITHUB_TOKEN}@github.com/MarcoDroll/creativewriter-public.git
          
          # Store the original commit info before making changes
          ORIGINAL_COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          ORIGINAL_COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "ORIGINAL_COMMIT_MESSAGE=$ORIGINAL_COMMIT_MESSAGE" >> $GITHUB_ENV
          echo "ORIGINAL_COMMIT_HASH=$ORIGINAL_COMMIT_HASH" >> $GITHUB_ENV
          
          # Create a temporary branch and filter files for public sync
          git checkout -b temp-public-sync
          
          # Copy the public docker-compose.yml to replace the private one
          if [ -f "docker-compose.public.yml" ]; then
            cp docker-compose.public.yml docker-compose.yml
            echo "âœ… Replaced docker-compose.yml with public version"
          fi
          
          # Copy the public Docker workflow file before removing .github
          mkdir -p .github-public/workflows
          if [ -f ".github/workflows/docker-public-images.yml" ]; then
            cp .github/workflows/docker-public-images.yml .github-public/workflows/docker-build.yml
            echo "âœ… Copied public Docker workflow"
          fi
          
          # Remove private development directories and files
          rm -rf .github/ || true  # Remove workflow files
          rm -rf .claude/ || true  # Remove Claude development files
          rm -rf .vscode/ || true  # Remove VS Code settings
          rm -rf .claudescreenshots/ || true  # Remove Claude screenshots
          rm -f docker-compose.public.yml || true  # Remove the public compose file itself
          rm -rf backend/ || true  # Remove Cloudflare Worker backend (premium features)

          # Whitelist approach: only keep docs/screenshots and docs/unraid
          if [ -d "docs" ]; then
            mkdir -p /tmp/docs-keep
            [ -d "docs/screenshots" ] && cp -r docs/screenshots /tmp/docs-keep/
            [ -d "docs/unraid" ] && cp -r docs/unraid /tmp/docs-keep/
            rm -rf docs/
            mkdir -p docs
            [ -d "/tmp/docs-keep/screenshots" ] && mv /tmp/docs-keep/screenshots docs/
            [ -d "/tmp/docs-keep/unraid" ] && mv /tmp/docs-keep/unraid docs/
            # Remove internal drafts from unraid folder
            rm -f docs/unraid/CA-ISSUE-DRAFT.md || true
            rm -f docs/unraid/CA-SUBMISSION.md || true
            rm -f docs/unraid/FORUM-POST-DRAFT.md || true
            rm -f docs/unraid/USER-REPLY-DRAFT.md || true
            rm -rf /tmp/docs-keep
            echo "âœ… Filtered docs/ to only screenshots/ and unraid/"
          fi

          # Replace premium components with public stubs
          CHAR_CHAT_DIR="src/app/stories/components/character-chat"
          if [ -f "${CHAR_CHAT_DIR}/character-chat.component.public.ts" ]; then
            mv "${CHAR_CHAT_DIR}/character-chat.component.public.ts" "${CHAR_CHAT_DIR}/character-chat.component.ts"
            echo "âœ… Replaced Character Chat with public stub"
          fi
          
          # Move the public workflow back to .github
          if [ -d ".github-public" ]; then
            mv .github-public .github
            echo "âœ… Added public workflow files"
          fi
          
          # Add all changes and force push without creating a commit in history
          git add -A
          git commit --amend --no-edit  # Amend the current commit instead of creating new one
          
          git push public temp-public-sync:main --force
          echo "âœ… Successfully synced release branch to public repository main branch (without private development files)"

      - name: Generate version and release info
        id: version
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          
          # Generate new version using timestamp for uniqueness
          TIMESTAMP=$(date +"%Y%m%d%H%M")
          MAJOR_MINOR=$(echo $CURRENT_VERSION | cut -d. -f1-2)
          NEW_VERSION="${MAJOR_MINOR}.${TIMESTAMP}"
          
          # Use the preserved original commit info
          COMMIT_HASH="${ORIGINAL_COMMIT_HASH}"
          COMMIT_MESSAGE="${ORIGINAL_COMMIT_MESSAGE}"
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Set outputs
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          
          echo "Generated version: v$NEW_VERSION"
          echo "Commit: $COMMIT_HASH - $COMMIT_MESSAGE"

  create-public-release:
    needs: sync-public
    runs-on: ubuntu-latest
    if: needs.sync-public.result == 'success'
    
    steps:
      # Note: Docker builds are triggered automatically when the release is created below
      # (via "on: release" in docker-build.yml). No need to trigger manually.

      - name: Checkout for release notes
        uses: actions/checkout@v4
        with:
          ref: release
          sparse-checkout: RELEASE_NOTES.md
          sparse-checkout-cone-mode: false

      - name: Create release in public repository
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          VERSION="${{ needs.sync-public.outputs.version }}"
          BUILD_DATE="${{ needs.sync-public.outputs.build_date }}"

          # Check if RELEASE_NOTES.md exists and use it
          if [ -f "RELEASE_NOTES.md" ]; then
            echo "ðŸ“ Found RELEASE_NOTES.md, using prepared release notes"

            # Append Docker images and Quick Start sections to the release notes
            {
              cat RELEASE_NOTES.md
              echo ""
              echo "## ðŸ“¦ Docker Images"
              echo ""
              echo "All images are multi-platform (AMD64, ARM64):"
              echo ""
              echo "| Image | Tags |"
              echo "|-------|------|"
              echo "| Main Application | \`ghcr.io/marcodroll/creativewriter-public:v${VERSION}\`, \`:stable\`, \`:latest\` |"
              echo "| Proxy Service | \`ghcr.io/marcodroll/creativewriter-public-proxy:v${VERSION}\` |"
              echo "| Gemini Proxy | \`ghcr.io/marcodroll/creativewriter-public-gemini-proxy:v${VERSION}\` |"
              echo "| Nginx Reverse Proxy | \`ghcr.io/marcodroll/creativewriter-public-nginx:v${VERSION}\` |"
              echo "| CouchDB Database | \`ghcr.io/marcodroll/creativewriter-public-couchdb:v${VERSION}\` |"
              echo ""
              echo "### Using Stable Tags"
              echo "\`\`\`bash"
              echo "docker pull ghcr.io/marcodroll/creativewriter-public:stable"
              echo "docker pull ghcr.io/marcodroll/creativewriter-public-nginx:stable"
              echo "docker pull ghcr.io/marcodroll/creativewriter-public-proxy:stable"
              echo "docker pull ghcr.io/marcodroll/creativewriter-public-gemini-proxy:stable"
              echo "docker pull ghcr.io/marcodroll/creativewriter-public-couchdb:stable"
              echo "\`\`\`"
              echo ""
              echo "## ðŸš€ Quick Start"
              echo ""
              echo "\`\`\`bash"
              echo "# Create directory and persistent storage"
              echo "mkdir creativewriter && cd creativewriter"
              echo "mkdir -p data"
              echo "chmod 755 data"
              echo ""
              echo "# Download docker-compose configuration"
              echo "curl -O https://raw.githubusercontent.com/MarcoDroll/creativewriter-public/main/docker-compose.yml"
              echo ""
              echo "# Start with persistent storage"
              echo "docker compose up -d"
              echo ""
              echo "# Access at http://localhost:3080"
              echo "\`\`\`"
              echo ""
              echo "---"
              echo "ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)"
            } > /tmp/release_notes.md
          else
            echo "âš ï¸ No RELEASE_NOTES.md found, creating minimal release notes"
            {
              echo "## ðŸš€ Release v${VERSION}"
              echo ""
              echo "**Build Date**: ${BUILD_DATE}"
              echo ""
              echo "See [CHANGELOG.md](https://github.com/MarcoDroll/creativewriter-public/blob/main/CHANGELOG.md) for details."
              echo ""
              echo "---"
              echo "ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)"
            } > /tmp/release_notes.md
          fi

          # Create the release in the public repository
          gh release create "v${VERSION}" \
            --repo MarcoDroll/creativewriter-public \
            --title "v${VERSION}" \
            --notes-file /tmp/release_notes.md \
            --latest

          echo "âœ… Created release v${VERSION} in public repository"
          echo "ðŸ”— Release URL: https://github.com/MarcoDroll/creativewriter-public/releases/tag/v${VERSION}"

      - name: Create sync summary
        run: |
          echo "# ðŸ”„ Public Repository Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Deployment (Production)**: âœ… Deployed to Cloudflare Workers" >> $GITHUB_STEP_SUMMARY
          echo "- **Private â†’ Public Sync**: âœ… Successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Creation**: âœ… Successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Images**: ðŸ”„ Building (triggered by release)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ New Release" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v${{ needs.sync-public.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL**: [v${{ needs.sync-public.outputs.version }}](https://github.com/MarcoDroll/creativewriter-public/releases/tag/v${{ needs.sync-public.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Registry**: [GitHub Container Registry](https://github.com/MarcoDroll/creativewriter-public/pkgs/container/creativewriter-public)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "The release will automatically trigger the stable Docker images workflow in the public repository." >> $GITHUB_STEP_SUMMARY
