<div class="ion-page">
  <app-header
    [title]="'Story Inspector'"
    [showBackButton]="true"
    [backAction]="goBack.bind(this)"
    [showBurgerMenu]="true"
    [burgerMenuTitle]="'Navigation'"
    [burgerMenuItems]="burgerMenuItems"
    [rightActions]="rightActions">
  </app-header>

  <ion-content>
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          Character Consistency Analyzer
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-progress-bar *ngIf="isAnalyzing" type="indeterminate" color="tertiary"></ion-progress-bar>

        <div class="context-chips" *ngIf="selectedScenes.length > 0">
          <ion-chip *ngFor="let s of selectedScenes" color="primary">
            <ion-label>{{ s.chapterTitle }} - {{ s.sceneTitle }}</ion-label>
            <ion-icon name="close-outline" (click)="removeSceneContext(s.sceneId)"></ion-icon>
          </ion-chip>
        </div>

        <div class="actions">
          <app-model-selector [(model)]="selectedModel" [placeholder]="'Select AI model'" [appendTo]="'body'"></app-model-selector>
          <ion-button color="primary" (click)="analyze()" [disabled]="selectedScenes.length === 0 || isAnalyzing">
            <ion-icon slot="start" name="search"></ion-icon>
            Analyze Selected
          </ion-button>
          <ion-spinner *ngIf="isAnalyzing" name="dots" class="analyzing-spinner" color="tertiary"></ion-spinner>
          <ion-badge color="medium" *ngIf="overview">Totals: {{ (overview.totals | json) }}</ion-badge>
          <ion-badge color="tertiary" *ngIf="isAnalyzing">Analyzing…</ion-badge>
        </div>

        <div *ngIf="overview as ov" style="margin-top:12px;">
          <div><strong>Totals</strong>: name={{ov.totals.name}} • trait={{ov.totals.trait}} • relationship={{ov.totals.relationship}} • timeline={{ov.totals.timeline}} • pov={{ov.totals.pov}} • other={{ov.totals.other}}</div>
          <div *ngIf="ov.byCharacter.length > 0" style="margin-top:6px;">
            <strong>Top characters with issues:</strong>
            <span *ngFor="let c of ov.byCharacter; let i=index">{{c.name}} ({{c.count}}) <span *ngIf="i < ov.byCharacter.length-1">•</span> </span>
          </div>
        </div>

        <div class="results" *ngIf="results.length > 0; else noResults">
          <ion-list>
            <ion-item *ngFor="let r of results">
              <ion-label>
                <div class="meta"><strong>{{ r.sceneTitle }}</strong> <span *ngIf="r.error" style="color:#e66">— {{r.error}}</span></div>
                <div *ngFor="let i of r.issues" style="margin-top:6px;">
                  <ion-badge color="warning" style="margin-right:8px;" slot="start">{{ i.type }}</ion-badge>
                  <span class="snippet">{{ i.character }} — {{ i.snippet }}</span>
                  <span class="meta" style="color:#999;"> — {{ i.why }}</span>
                  <div *ngIf="i.suggestion" style="color:#6aa84f; margin-left: 8px;">Suggestion: {{ i.suggestion }}</div>
                  <div>
                    <ion-button size="small" fill="clear" color="primary" (click)="openInEditor(r, i)">
                      <ion-icon name="open-outline" slot="start"></ion-icon>
                      Open in Editor
                    </ion-button>
                  </div>
                </div>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>
        <ng-template #noResults>
          <div class="meta" *ngIf="!isAnalyzing">No results yet. Select scenes and click Analyze.</div>
          <div class="busy" *ngIf="isAnalyzing">
            <ion-spinner name="crescent" color="tertiary"></ion-spinner>
            <div class="busy-text">Analyzing selected scenes…</div>
          </div>
        </ng-template>
      </ion-card-content>
    </ion-card>
  </ion-content>
</div>

<ion-modal [isOpen]="showSceneSelector" (didDismiss)="showSceneSelector = false">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Select Scenes for Analysis</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="showSceneSelector = false">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <ion-searchbar [(ngModel)]="sceneSearchTerm" placeholder="Search scenes..." animated="true"></ion-searchbar>
      <ion-list>
        <div *ngFor="let chapter of story?.chapters">
          <ion-item-divider>
            <ion-label>C{{ chapter.chapterNumber || chapter.order }}:{{ chapter.title }}</ion-label>
          </ion-item-divider>
          <ion-item *ngFor="let scene of getFilteredScenes(chapter)" [button]="true" (click)="toggleSceneSelection(chapter.id, scene.id)">
            <ion-checkbox slot="start" [checked]="isSceneSelected(scene.id)"></ion-checkbox>
            <ion-label>
              <h3>C{{ chapter.chapterNumber || chapter.order }}S{{ scene.sceneNumber || scene.order }}:{{ scene.title }}</h3>
              <p>{{ getScenePreview(scene.content) }}</p>
            </ion-label>
          </ion-item>
        </div>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>
