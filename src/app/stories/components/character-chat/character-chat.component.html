<div class="ion-page">
  <app-header
    [title]="'Character Chat'"
    [showBackButton]="true"
    [backAction]="goBack.bind(this)"
    [rightActions]="headerActions"
    [showSecondaryToolbar]="isPremium && !!selectedCharacter && !isModuleLoading"
    [secondaryContent]="modelToolbar">
  </app-header>

  <ng-template #modelToolbar>
    <div class="model-selection-container">
      <app-model-selector
        [(model)]="selectedModel"
        [clearable]="false"
        [searchable]="true"
        [quickPickIds]="quickPickIds"
        placeholder="Select model..."
        appendTo="body">
      </app-model-selector>
    </div>
  </ng-template>

  <ion-content class="chat-content">
    <!-- Premium Required Message -->
    <div *ngIf="!isPremium" class="premium-required">
      <ion-icon name="lock-closed" class="lock-icon"></ion-icon>
      <h2>Premium Feature</h2>
      <p>Character Chat is a premium feature. Subscribe to unlock conversations with your characters.</p>
      <ion-button routerLink="/settings" [queryParams]="{tab: 'premium'}">
        Go to Settings
      </ion-button>
    </div>

    <!-- Module Loading -->
    <div *ngIf="isPremium && isModuleLoading" class="loading-state">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading Character Chat...</p>
    </div>

    <!-- Module Error -->
    <div *ngIf="isPremium && moduleError && !isModuleLoading" class="error-state">
      <ion-icon name="alert-circle" class="error-icon"></ion-icon>
      <p>{{ moduleError }}</p>
      <ion-button (click)="loadPremiumModule()">Try Again</ion-button>
    </div>

    <!-- Character Selection (when no character selected) -->
    <div *ngIf="isPremium && !selectedCharacter && !isModuleLoading && !moduleError" class="character-selection">
      <h2>Select a Character</h2>
      <p>Choose a character from your codex to start chatting.</p>

      <div *ngIf="characters.length === 0" class="no-characters">
        <ion-icon name="person-add-outline"></ion-icon>
        <p>No characters found in your codex. Add characters to your story's codex to chat with them.</p>
      </div>

      <div class="character-grid">
        <div *ngFor="let character of characters"
             class="character-card"
             (click)="selectCharacter(character)"
             (keydown.enter)="selectCharacter(character)"
             tabindex="0"
             role="button">
          <div class="character-avatar">
            <ion-icon name="person-circle"></ion-icon>
          </div>
          <div class="character-info">
            <h3>{{ character.title }}</h3>
            <p *ngIf="character.storyRole" class="role-badge">{{ character.storyRole }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Interface -->
    <div *ngIf="isPremium && selectedCharacter && !isModuleLoading" class="chat-interface">
      <!-- Character Header -->
      <div class="character-header">
        <ion-chip (click)="selectedCharacter = null" class="back-chip">
          <ion-icon name="arrow-back"></ion-icon>
          <ion-label>Change Character</ion-label>
        </ion-chip>
        <div class="character-name">
          <ion-icon name="person-circle"></ion-icon>
          <span>{{ selectedCharacter.title }}</span>
        </div>
        <ion-chip *ngIf="knowledgeCutoff" color="warning" (click)="openKnowledgeSettings()">
          <ion-icon name="time-outline"></ion-icon>
          <ion-label>Knowledge Limited</ion-label>
        </ion-chip>
      </div>

      <!-- Messages -->
      <div class="chat-messages" #scrollContainer>
        <!-- Welcome message -->
        <div *ngIf="messages.length === 0" class="welcome-message">
          <p>Start a conversation with {{ selectedCharacter.title }}.</p>

          <!-- Suggested starters -->
          <div class="starters" *ngIf="suggestedStarters.length > 0">
            <p class="starters-label">Try asking:</p>
            <ion-chip *ngFor="let starter of suggestedStarters"
                      (click)="useStarter(starter)"
                      class="starter-chip">
              {{ starter }}
            </ion-chip>
          </div>
        </div>

        <!-- Message list -->
        <div *ngFor="let message of messages; let i = index"
             class="message"
             [class.user-message]="message.role === 'user'"
             [class.assistant-message]="message.role === 'assistant'"
             [class.editing]="editingMessageIndex === i">
          <div class="message-avatar">
            <ion-avatar>
              <ion-icon [name]="message.role === 'user' ? 'person-outline' : 'person-circle'"></ion-icon>
            </ion-avatar>
          </div>
          <div class="message-content">
            <!-- Normal view -->
            <ng-container *ngIf="editingMessageIndex !== i">
              <div class="message-text">{{ message.content }}</div>
              <div class="message-meta">
                <span class="message-time">{{ formatTime(message.timestamp) }}</span>
                <!-- Copy button -->
                <ion-button
                  size="small"
                  fill="clear"
                  color="medium"
                  (click)="copyMessage(message.content)"
                  title="Copy message">
                  <ion-icon name="copy-outline" slot="icon-only"></ion-icon>
                </ion-button>
                <!-- Edit button for user messages -->
                <ion-button
                  *ngIf="message.role === 'user' && !isGenerating"
                  size="small"
                  fill="clear"
                  color="medium"
                  (click)="startEditMessage(i)"
                  title="Edit message">
                  <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                </ion-button>
                <!-- Retry button for last assistant message -->
                <ion-button
                  *ngIf="message.role === 'assistant' && isLastAssistantMessage(i) && !isGenerating"
                  size="small"
                  fill="clear"
                  color="medium"
                  (click)="retryLastMessage()"
                  title="Regenerate response">
                  <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
            </ng-container>

            <!-- Edit mode -->
            <ng-container *ngIf="editingMessageIndex === i">
              <div class="edit-container">
                <ion-textarea
                  [(ngModel)]="editingContent"
                  [autoGrow]="true"
                  [rows]="2"
                  class="edit-textarea"
                  placeholder="Edit your message...">
                </ion-textarea>
                <div class="edit-actions">
                  <ion-button
                    size="small"
                    fill="clear"
                    color="medium"
                    (click)="cancelEditMessage()"
                    title="Cancel">
                    <ion-icon name="close-outline" slot="icon-only"></ion-icon>
                  </ion-button>
                  <ion-button
                    size="small"
                    fill="clear"
                    color="primary"
                    (click)="submitEditedMessage()"
                    [disabled]="!editingContent.trim()"
                    title="Send edited message">
                    <ion-icon name="checkmark-outline" slot="icon-only"></ion-icon>
                  </ion-button>
                </div>
              </div>
            </ng-container>
          </div>
        </div>

        <!-- Typing indicator -->
        <div *ngIf="isGenerating" class="message assistant-message">
          <div class="message-avatar">
            <ion-avatar>
              <ion-icon name="person-circle"></ion-icon>
            </ion-avatar>
          </div>
          <div class="message-content">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ion-content>

  <!-- Input Footer (only when character selected) -->
  <ion-footer *ngIf="isPremium && selectedCharacter && !isModuleLoading" class="chat-footer">
    <div class="input-container">
      <ion-textarea
        #messageInput
        [(ngModel)]="currentMessage"
        placeholder="Type a message..."
        [autoGrow]="true"
        [rows]="1"
        (keydown.enter)="onEnterKey($any($event))"
        class="message-input">
      </ion-textarea>
      <ion-button
        (click)="sendMessage()"
        [disabled]="!currentMessage.trim() || isGenerating"
        fill="clear"
        class="send-button">
        <ion-icon name="send" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
  </ion-footer>
</div>

<!-- Knowledge Cutoff Modal -->
<ion-modal [isOpen]="showKnowledgeModal" (didDismiss)="showKnowledgeModal = false">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Knowledge Cutoff</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="showKnowledgeModal = false">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <p class="modal-description">
        Set a knowledge cutoff to limit what {{ selectedCharacter?.title }} knows about the story.
        The character will only be aware of events up to the selected point.
      </p>

      <ion-list *ngIf="story && story.chapters">
        <ion-item *ngFor="let chapter of story.chapters"
                  [button]="true"
                  (click)="setKnowledgeCutoff(chapter.order)">
          <ion-label>
            <h3>Chapter {{ chapter.order }}: {{ chapter.title }}</h3>
            <p>{{ chapter.scenes.length || 0 }} scenes</p>
          </ion-label>
          <ion-icon name="checkmark" slot="end"
                    *ngIf="knowledgeCutoff?.chapterOrder === chapter.order"></ion-icon>
        </ion-item>
      </ion-list>

      <ion-button expand="block" fill="outline" color="medium" (click)="clearKnowledgeCutoff()">
        Clear Cutoff (Full Knowledge)
      </ion-button>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Chat History Modal -->
<ion-modal [isOpen]="showHistoryList" (didDismiss)="closeHistoryList()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Chat History</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeHistoryList()">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <div *ngIf="histories.length === 0" class="no-histories">
        <ion-icon name="chatbubbles" class="empty-icon"></ion-icon>
        <p>No chat history yet.</p>
        <p class="hint">Start a conversation to save your chat history.</p>
      </div>

      <ion-list *ngIf="histories.length > 0">
        <ion-item *ngFor="let history of histories"
                  [button]="true"
                  (click)="selectHistory(history)">
          <ion-icon name="chatbubbles" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>{{ getHistoryTitle(history) }}</h3>
            <p>{{ getHistoryMeta(history) }}</p>
          </ion-label>
          <ion-icon name="chevron-forward" slot="end" color="medium"></ion-icon>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>
