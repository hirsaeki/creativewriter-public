<div class="story-structure" role="navigation" aria-label="Story structure">
  <div class="structure-header">
    <h2>Structure</h2>
    <ion-button 
      fill="clear" 
      size="small"
      class="close-button"
      (click)="onCloseSidebar()"
      aria-label="Close sidebar">
      <ion-icon name="close" slot="icon-only"></ion-icon>
    </ion-button>
  </div>
  
  <ion-content class="structure-content" [scrollEvents]="true">
    <div id="add-chapter-help" class="sr-only">
      Adds a new chapter to the story
    </div>
    
    <div class="structure-actions">
      <ion-button 
        expand="block" 
        fill="outline" 
        color="primary" 
        class="add-chapter-btn" 
        (click)="addChapter()"
        aria-label="Add new chapter">
        <ion-icon name="add" slot="start" [attr.aria-hidden]="true"></ion-icon>
        New Chapter
      </ion-button>
    </div>
    
    <ion-list class="chapters-list" role="tree" aria-label="Chapters and Scenes">
      <div *ngFor="let chapter of story.chapters; trackBy: trackChapter" 
           class="chapter-item">
        
        <ion-item 
          button 
          detail="false" 
          (click)="toggleChapter(chapter.id)" 
          (keydown)="onChapterKeyDown($event, chapter.id)"
          class="chapter-header"
          role="treeitem"
          tabindex="0"
          [attr.aria-expanded]="expandedChapters.has(chapter.id)"
          [attr.aria-label]="'Chapter: ' + (chapter.title || 'Untitled') + '. ' + (expandedChapters.has(chapter.id) ? 'Collapsed' : 'Expanded')">
          <ion-icon 
            [name]="expandedChapters.has(chapter.id) ? 'chevron-down' : 'chevron-forward'" 
            slot="start" 
            class="expand-icon"
            (click)="toggleChapter(chapter.id); $event.stopPropagation()"
            [attr.aria-hidden]="true">
          </ion-icon>
          <div class="chapter-title-container">
            <div class="chapter-id-display">{{ 'C' + (chapter.chapterNumber || chapter.order) }}</div>
            <ion-input 
              [(ngModel)]="chapter.title" 
              (ionBlur)="updateChapter(chapter)"
              (click)="$event.stopPropagation()"
              (keydown.space)="$event.stopPropagation()"
              (keydown.enter)="$event.stopPropagation()"
              class="chapter-title-input"
              placeholder="Chapter Title"
              [attr.aria-label]="'Edit chapter title'"
            ></ion-input>
          </div>
          <ion-button 
            fill="clear" 
            color="danger" 
            slot="end" 
            (click)="deleteChapter(chapter.id, $event)"
            [attr.aria-label]="'Delete chapter: ' + (chapter.title || 'Untitled')">
            <ion-icon name="trash" slot="icon-only" [attr.aria-hidden]="true"></ion-icon>
          </ion-button>
        </ion-item>
        
        <div class="scenes-list" *ngIf="expandedChapters.has(chapter.id)" role="group" [attr.aria-label]="'Scenes in chapter: ' + (chapter.title || 'Untitled')">
          <ion-list role="none">
            <ng-container *ngFor="let scene of chapter.scenes; trackBy: trackScene">
              <ion-item 
                button
                detail="false"
                [class.active-scene]="isActiveScene(chapter.id, scene.id)"
                (click)="selectScene(chapter.id, scene.id)"
                (keydown)="onSceneKeyDown($event, chapter.id, scene.id)"
                class="scene-item multi-line"
                role="treeitem"
                tabindex="0"
                [attr.aria-selected]="isActiveScene(chapter.id, scene.id)"
                [attr.aria-label]="'Scene: ' + (scene.title || 'Untitled') + '. ' + (getWordCount(scene.content)) + ' words' + (isActiveScene(chapter.id, scene.id) ? '. Currently selected' : '')">
                
                <div class="scene-content">
                  <!-- First line: Scene title with AI button -->
                  <div class="scene-title-row">
                    <div class="scene-title-container">
                      <div class="scene-id-display">{{ 'C' + (chapter.chapterNumber || chapter.order) + 'S' + (scene.sceneNumber || scene.order) }}</div>
                      <div 
                        *ngIf="!isEditingTitle.has(scene.id)"
                        class="scene-title-display"
                        (click)="startEditingTitle(scene.id, $event)"
                        [attr.aria-label]="'Scene title: ' + (scene.title || 'Untitled') + '. Click to edit.'"
                        tabindex="0"
                        (keydown.enter)="startEditingTitle(scene.id, $event)"
                        (keydown.space)="startEditingTitle(scene.id, $event)">
                        {{ scene.title || 'Scene Title' }}
                      </div>
                      <ion-input 
                        *ngIf="isEditingTitle.has(scene.id)"
                        [(ngModel)]="scene.title" 
                        (ionBlur)="stopEditingTitle(chapter.id, scene)"
                        (keydown.enter)="stopEditingTitle(chapter.id, scene); $event.stopPropagation()"
                        (keydown.escape)="cancelEditingTitle(scene); $event.stopPropagation()"
                        (keydown.space)="$event.stopPropagation()"
                        (click)="$event.stopPropagation()"
                        class="scene-title-input-edit"
                        placeholder="Scene Title"
                        fill="clear"
                        [attr.aria-label]="'Edit scene title'"
                        #titleInput
                      ></ion-input>
                    </div>
                    
                    <ion-button 
                      fill="clear" 
                      size="small"
                      [color]="isGeneratingTitle.has(scene.id) ? 'medium' : 'primary'"
                      (click)="generateSceneTitle(chapter.id, scene.id, $event)"
                      [disabled]="isGeneratingTitle.has(scene.id) || !selectedModel || !scene.content.trim()"
                      class="ai-title-btn"
                      [attr.aria-label]="isGeneratingTitle.has(scene.id) ? 'Title is being generated...' : 'Generate AI title for scene'"
                      (touchstart)="$event.stopPropagation()"
                      (touchend)="$event.stopPropagation()">
                      <ion-icon 
                        [name]="isGeneratingTitle.has(scene.id) ? 'time-outline' : 'sparkles-outline'" 
                        slot="icon-only"
                        [attr.aria-hidden]="true">
                      </ion-icon>
                    </ion-button>
                  </div>
                  
                  <!-- Second line: Word count and action buttons -->
                  <div class="scene-actions-row">
                    <ion-badge color="medium" class="word-count-badge">
                      {{ getWordCount(scene.content) }} words
                    </ion-badge>
                    
                    <div class="action-buttons">
                      <ion-button 
                        fill="clear" 
                        size="small"
                        [color]="scene.summary ? 'success' : 'medium'"
                        (click)="toggleSceneDetails(scene.id, $event)"
                        class="expand-scene-btn"
                        [attr.aria-label]="'Scene details ' + (expandedScenes.has(scene.id) ? 'collapse' : 'expand')"
                        [attr.aria-expanded]="expandedScenes.has(scene.id)"
                        (touchstart)="$event.stopPropagation()"
                        (touchend)="$event.stopPropagation()">
                        <ion-icon 
                          [name]="expandedScenes.has(scene.id) ? 'chevron-down' : 'chevron-forward'" 
                          slot="icon-only"
                          [attr.aria-hidden]="true">
                        </ion-icon>
                      </ion-button>
                      
                      
                      <ion-button 
                        fill="clear" 
                        size="small"
                        color="danger" 
                        (click)="deleteScene(chapter.id, scene.id, $event)"
                        [attr.aria-label]="'Delete scene: ' + (scene.title || 'Untitled')"
                        (touchstart)="$event.stopPropagation()"
                        (touchend)="$event.stopPropagation()">
                        <ion-icon name="trash" slot="icon-only" [attr.aria-hidden]="true"></ion-icon>
                      </ion-button>
                    </div>
                  </div>
                </div>
              </ion-item>
              
              <div class="scene-details" *ngIf="expandedScenes.has(scene.id)">
                <div class="scene-summary-section">
                  <div class="summary-header">
                    <span>Summary</span>
                    <div class="summary-buttons">
                      <ion-button 
                        size="small"
                        fill="solid"
                        [color]="isGeneratingSummary.has(scene.id) ? 'medium' : 'success'"
                        (click)="generateSceneSummary(chapter.id, scene.id)"
                        [disabled]="isGeneratingSummary.has(scene.id) || !selectedModel || !scene.content.trim()"
                        [attr.aria-label]="isGeneratingSummary.has(scene.id) ? 'Summary is being generated...' : 'Generate AI summary for scene'"
                        (touchstart)="$event.stopPropagation()"
                        (touchend)="$event.stopPropagation()">
                        <ion-icon 
                          [name]="isGeneratingSummary.has(scene.id) ? 'time-outline' : 'flash-outline'" 
                          slot="icon-only"
                          [attr.aria-hidden]="true">
                        </ion-icon>
                      </ion-button>
                      <ion-button 
                        *ngIf="scene.summary"
                        size="small"
                        fill="solid"
                        color="danger"
                        (click)="deleteSceneSummary(chapter.id, scene.id)"
                        [attr.aria-label]="'Delete summary for scene'"
                        (touchstart)="$event.stopPropagation()"
                        (touchend)="$event.stopPropagation()">
                        <ion-icon 
                          name="trash" 
                          slot="icon-only"
                          [attr.aria-hidden]="true">
                        </ion-icon>
                      </ion-button>
                    </div>
                  </div>
                  
                  <div class="summary-favorites" *ngIf="summaryFavoriteModels.length > 0">
                    <ion-icon name="star-outline" class="favorite-icon" aria-hidden="true"></ion-icon>
                    <div class="favorite-buttons" role="list">
                      <button *ngFor="let model of summaryFavoriteModels"
                              type="button"
                              class="favorite-btn"
                              role="listitem"
                              [class.active]="selectedModel === model.id"
                              (click)="selectSummaryFavorite(model)"
                              [title]="model.label">
                        <span class="favorite-btn-content">
                          <app-openrouter-icon *ngIf="model.provider === 'openrouter'" size="14" color="#6467f2" class="provider-icon-inline openrouter"></app-openrouter-icon>
                          <ion-icon *ngIf="model.provider !== 'openrouter'" [name]="getProviderIcon(model.provider)" class="provider-icon-inline"></ion-icon>
                          <span class="model-short-name">{{ getShortModelName(model.label) }}</span>
                        </span>
                      </button>
                    </div>
                  </div>

                  <ion-select 
                    [(ngModel)]="selectedModel"
                    placeholder="Choose AI model..."
                    interface="popover"
                    class="model-select"
                    aria-label="Select AI model for summary"
>
                    <ion-select-option *ngFor="let model of availableModels" [value]="model.id">
                      {{ model.label }}
                    </ion-select-option>
                  </ion-select>
                  
                  <ion-textarea 
                    [(ngModel)]="scene.summary"
                    [value]="scene.summary || ''"
                    (ionBlur)="updateSceneSummary(chapter.id, scene.id, scene.summary || '')"
                    (ionInput)="autoResizeTextarea($event)"
                    [attr.data-scene-id]="scene.id"
                    placeholder="AI-generated scene summary will be displayed here..."
                    class="summary-textarea"
                    [rows]="2"
                    [autoGrow]="false"
                    [attr.aria-label]="'Summary for scene: ' + (scene.title || 'Untitled')">
                  </ion-textarea>
                  
                  <ion-chip *ngIf="scene.summaryGeneratedAt" color="medium" class="summary-info">
                    <ion-icon name="time-outline"></ion-icon>
                    <ion-label>{{ scene.summaryGeneratedAt | date:'short' }}</ion-label>
                  </ion-chip>
                </div>
              </div>
            </ng-container>
          </ion-list>
          
          <ion-button 
            expand="block" 
            fill="outline" 
            color="primary" 
            class="add-scene-btn" 
            (click)="addScene(chapter.id)"
            [attr.aria-label]="'Add new scene to chapter: ' + (chapter.title || 'Untitled')">
            <ion-icon name="add" slot="start" [attr.aria-hidden]="true"></ion-icon>
            New Scene
          </ion-button>
        </div>
      </div>
    </ion-list>
  </ion-content>
</div>
