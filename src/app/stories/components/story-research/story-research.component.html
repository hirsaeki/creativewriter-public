<div class="ion-page">
  <app-header
    title="Story Research"
    [showBackButton]="true"
    [backAction]="goBack.bind(this)"
    [rightActions]="headerActions">
  </app-header>

  <ion-content class="research-content">
    <div class="content-wrapper">
      <ion-card class="task-card">
        <ion-card-header>
          <ion-card-title>Research Task</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="cost-warning">
            <ion-icon name="warning-outline"></ion-icon>
            <div>
              <p>Story research sends the full text of every scene to the selected model and finishes with a summary prompt. Expect very high token usage on expensive models.</p>
              <div class="cost-metrics">
                <ion-badge color="warning">{{ sceneCountLabel }}</ion-badge>
                <ion-badge color="medium">≈ {{ estimatedInputTokens | number }} context tokens</ion-badge>
              </div>
            </div>
          </div>
          <div class="selector-row">
            <label for="model">AI model</label>
            <app-model-selector [(model)]="selectedModel" [appendTo]="'body'" [placeholder]="'Select AI model'"></app-model-selector>
          </div>
          <ion-textarea
            [(ngModel)]="task"
            [autoGrow]="true"
            rows="4"
            placeholder="Describe what you want the AI to investigate across the story…"
            class="task-input">
          </ion-textarea>
          <ion-button expand="block" color="primary" (click)="startResearch()" [disabled]="isRunning || !task.trim()">
            <ion-icon name="play-outline" slot="start"></ion-icon>
            Start research
          </ion-button>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="isRunning" class="progress-card">
        <ion-card-header>
          <ion-card-title>Running research</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="progress-row">
            <ion-spinner name="dots"></ion-spinner>
            <span>{{ progressMessage || 'Processing scenes…' }}</span>
          </div>
          <ion-progress-bar [value]="progressValue"></ion-progress-bar>
          <div class="progress-stats">
            <span>{{ progressIndex + 1 }} / {{ totalScenes }} scenes</span>
            <span>Provider: {{ providerLabel(currentRunModel) }}</span>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="errorMessage" class="error-card">
        <ion-card-header>
          <ion-card-title>Research failed</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>{{ errorMessage }}</p>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="activeStatus !== 'idle'" class="metadata-card">
        <ion-card-header>
          <ion-card-title>Research overview</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-item lines="none">
            <ion-label>
              <p class="item-label">Task</p>
              <h3>{{ activeTask }}</h3>
            </ion-label>
          </ion-item>
          <ion-item lines="none">
            <ion-label>
              <p class="item-label">Model</p>
              <h3>{{ activeModel }}</h3>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="viewingHistory" lines="none">
            <ion-label>
              <p class="item-label">Run completed</p>
              <h3>{{ formatDate(viewingHistory.updatedAt) }}</h3>
            </ion-label>
            <ion-badge slot="end" [color]="viewingHistory.status === 'completed' ? 'success' : 'danger'">{{ viewingHistory.status }}</ion-badge>
          </ion-item>
          <ion-item *ngIf="viewingHistory?.errorMessage" lines="none">
            <ion-label>
              <p class="item-label">Notes</p>
              <h3>{{ viewingHistory?.errorMessage }}</h3>
            </ion-label>
          </ion-item>
        </ion-card-content>
        <ion-button *ngIf="viewingHistory" expand="block" fill="outline" color="medium" (click)="clearHistorySelection()">
          <ion-icon name="refresh-outline" slot="start"></ion-icon>
          Back to current session
        </ion-button>
      </ion-card>

      <ion-card *ngIf="isRunning && sceneProgress.length" class="progress-list-card">
        <ion-card-header>
          <ion-card-title>Scene queue</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list lines="none">
            <ion-item *ngFor="let progress of sceneProgress">
              <ion-badge slot="start" [color]="sceneStatusColor(progress.status)">{{ progress.status }}</ion-badge>
              <ion-label>
                <h3>{{ progress.chapterTitle }} – {{ progress.sceneTitle }}</h3>
                <p *ngIf="progress.tokenEstimate">≈ {{ progress.tokenEstimate | number }} context tokens</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="activeSceneFindings.length" class="findings-card">
        <ion-card-header>
          <ion-card-title>Scene findings</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list lines="none">
            <ion-item *ngFor="let finding of activeSceneFindings">
              <ion-icon slot="start" name="document-text-outline"></ion-icon>
              <ion-label>
                <h3>{{ finding.chapterTitle }} – {{ finding.sceneTitle }}</h3>
                <div class="finding-response">{{ finding.response }}</div>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="activeSummary" class="summary-card">
        <ion-card-header>
          <ion-card-title>Final synthesis</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="summary-text">{{ activeSummary }}</div>
        </ion-card-content>
      </ion-card>
    </div>
  </ion-content>
</div>

<ion-modal [isOpen]="showHistoryList" (didDismiss)="closeHistoryModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Research history</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeHistoryModal()">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <ion-list>
        <ion-item *ngIf="!histories.length">
          <ion-label>No stored research sessions yet.</ion-label>
        </ion-item>
        <ion-item 
          *ngFor="let history of histories"
          (click)="selectHistory(history)"
          button
          detail="true">
          <ion-label>
            <h2>{{ history.task }}</h2>
            <p>{{ formatDate(history.updatedAt) }} · {{ history.model }}</p>
          </ion-label>
          <ion-badge slot="end" [color]="history.status === 'completed' ? 'success' : 'danger'">{{ history.status }}</ion-badge>
          <ion-button fill="clear" color="danger" slot="end" (click)="$event.stopPropagation(); deleteHistory(history)">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>
