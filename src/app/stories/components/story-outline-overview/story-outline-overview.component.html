<app-header
  [title]="'Outline Overview'"
  [leftActions]="leftActions"
  [rightActions]="rightActions"
  [showBurgerMenu]="false"
></app-header>

<ion-content [fullscreen]="true">
  <!-- Floating Action Button to toggle model selection -->
  <ion-fab class="model-fab" vertical="top" horizontal="end" slot="fixed">
    <ion-fab-button
      aria-label="Toggle model selection"
      (click)="toggleToolbar()"
      [color]="toolbarVisible() ? 'primary' : 'medium'"
      size="small">
      <ion-icon [name]="toolbarVisible() ? 'funnel' : 'funnel-outline'"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <button
    type="button"
    class="mobile-model-fab"
    [class.is-open]="toolbarVisible()"
    (click)="toggleToolbar()"
    [attr.aria-expanded]="toolbarVisible()"
    aria-controls="model-selection-panel">
    <ion-icon [name]="toolbarVisible() ? 'close-outline' : 'funnel-outline'"></ion-icon>
    <span>{{ toolbarVisible() ? 'Close model selection' : 'Model selection' }}</span>
  </button>

  <button
    type="button"
    class="mobile-toolbar-backdrop"
    *ngIf="toolbarVisible()"
    (click)="closeToolbar()"
    (keydown.enter)="closeToolbar()"
    (keydown.space)="closeToolbar()"
    aria-label="Close model selection">
  </button>

  <!-- Collapsible Toolbar -->
  <div
    id="model-selection-panel"
    class="toolbar"
    [class.visible]="toolbarVisible()"
    role="region"
    aria-label="Model selection">
    <div class="toolbar-mobile-header">
      <h2>Model selection</h2>
      <ion-button
        size="small"
        fill="clear"
        color="light"
        (click)="closeToolbar()">
        <ion-icon slot="icon-only" name="close-outline"></ion-icon>
      </ion-button>
    </div>
    <ion-searchbar
      placeholder="Search titles and summaries"
      [debounce]="150"
      (ionInput)="query.set($any($event.target).value || '')">
    </ion-searchbar>
    <app-model-selector [(model)]="selectedModel" [placeholder]="'Select AI model'" [appendTo]="'body'"></app-model-selector>
  </div>

  <div class="story-meta" *ngIf="story() as s">
    <div class="title">{{ s.title || 'Untitled Story' }}</div>
    <div class="meta">{{ s.chapters?.length || 0 }} chapter(s)</div>
  </div>

  <div *ngIf="loading()" class="loading">
    <ion-skeleton-text [animated]="true" style="width: 60%; height: 20px;"></ion-skeleton-text>
    <ion-skeleton-text [animated]="true" style="width: 90%; height: 16px;"></ion-skeleton-text>
    <ion-skeleton-text [animated]="true" style="width: 80%; height: 16px;"></ion-skeleton-text>
  </div>

  <ion-accordion-group *ngIf="!loading()" [multiple]="true" [value]="expandedArray()" (ionChange)="onAccordionChange($event)">
    <ion-accordion *ngFor="let chapter of filteredChapters(); trackBy: trackChapterById" [value]="chapter.id">
      <ion-item slot="header" lines="full">
        <ion-label>
          <div class="chapter-header-row">
            <div class="chapter-title">
              <ng-container *ngIf="!isEditingChapterTitle(chapter.id); else editChapterTpl">
                <span class="idx">{{chapter.chapterNumber}}.</span>
                <span>{{ chapter.title || 'Untitled Chapter' }}</span>
              </ng-container>
              <ng-template #editChapterTpl>
                <div class="chapter-edit">
                  <span class="idx">{{chapter.chapterNumber}}.</span>
                  <ion-input
                    class="chapter-edit-input"
                    [ngModel]="editingChapterTitles[chapter.id] || ''"
                    (ngModelChange)="onEditChapterTitleChange(chapter.id, $event, $event)"
                    placeholder="Untitled Chapter"
                    (click)="$event.stopPropagation()"
                    (keydown)="$event.stopPropagation()"
                    (keydown.enter)="saveChapterTitle(chapter.id, $event)">
                  </ion-input>
                </div>
              </ng-template>
            </div>
            <div class="chapter-actions">
              <ion-button *ngIf="!isEditingChapterTitle(chapter.id)" fill="outline" size="small" color="medium" (click)="startEditChapterTitle(chapter.id, chapter.title, $event)">
                <ion-icon name="create-outline" slot="start"></ion-icon>
                Edit Title
              </ion-button>
              <ion-button *ngIf="isEditingChapterTitle(chapter.id)" size="small" color="primary" [disabled]="savingChapterTitle(chapter.id)" (click)="saveChapterTitle(chapter.id, $event)">
                <ion-icon name="save-outline" slot="start"></ion-icon>
                Save
              </ion-button>
              <ion-button *ngIf="isEditingChapterTitle(chapter.id)" fill="outline" size="small" color="medium" [disabled]="savingChapterTitle(chapter.id)" (click)="cancelEditChapterTitle(chapter.id, $event)">
                <ion-icon name="close-outline" slot="start"></ion-icon>
                Cancel
              </ion-button>
            </div>
          </div>
          <ion-note>{{ chapter.scenes.length }} scene(s)</ion-note>
        </ion-label>
      </ion-item>
      <div class="chapter-content" slot="content">
        <ion-list lines="none">
          <ion-card *ngFor="let scene of chapter.scenes; trackBy: trackSceneById" class="scene-card" [id]="'scene-' + scene.id">
            <ion-card-header>
              <ion-card-title>
                <ng-container *ngIf="!isEditingTitle(scene.id); else editTitleTpl">
                  <span class="idx">{{scene.sceneNumber}}.</span>
                  <span>{{ scene.title || 'Untitled Scene' }}</span>
                  <ion-badge color="warning" *ngIf="!scene.summary">No summary</ion-badge>
                </ng-container>
                <ng-template #editTitleTpl>
                  <div class="title-edit">
                    <span class="idx">{{scene.sceneNumber}}.</span>
                    <ion-input
                      class="title-input"
                      [ngModel]="editingTitles[scene.id] || ''"
                      (ngModelChange)="onEditTitleChange(scene.id, $event)"
                      placeholder="Untitled Scene"
                      (keydown.enter)="saveSceneTitle(chapter.id, scene.id)">
                    </ion-input>
                  </div>
                </ng-template>
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ng-container *ngIf="!isEditing(scene.id); else editSummaryTpl">
                <div class="summary" [class.placeholder]="!scene.summary">
                  {{ scene.summary || 'No summary available for this scene.' }}
                </div>
              </ng-container>

              <ng-template #editSummaryTpl>
                <div class="summary-edit">
                  <ion-textarea
                    [ngModel]="editingSummaries[scene.id] || ''"
                    (ngModelChange)="onEditSummaryChange(scene.id, $event)"
                    [autoGrow]="true"
                    rows="6"
                    placeholder="Write a short summary for this scene..."
                    (keydown)="onSummaryKeydown($event, chapter.id, scene.id)">
                  </ion-textarea>
                </div>
              </ng-template>

              <div class="actions">
                <ion-button *ngIf="!isEditingTitle(scene.id) && !isEditing(scene.id)"
                            size="small" fill="outline" color="primary"
                            (click)="generateSceneTitle(chapter.id, scene.id)"
                            [disabled]="isGeneratingTitle(scene.id) || !(scene.content && scene.content.trim()) || !selectedModel">
                  <ion-icon [name]="isGeneratingTitle(scene.id) ? 'time-outline' : 'sparkles-outline'" slot="start"></ion-icon>
                  {{ isGeneratingTitle(scene.id) ? 'Generating…' : 'AI Title' }}
                  <ion-spinner *ngIf="isGeneratingTitle(scene.id)" name="dots" style="width: 14px; height: 14px; margin-left: 6px;"></ion-spinner>
                </ion-button>

                <ion-button *ngIf="!isEditingTitle(scene.id) && !isEditing(scene.id)"
                            size="small" color="success"
                            (click)="generateSceneSummary(chapter.id, scene.id)"
                            [disabled]="isGeneratingSummary(scene.id) || !(scene.content && scene.content.trim()) || !selectedModel">
                  <ion-icon [name]="isGeneratingSummary(scene.id) ? 'time-outline' : 'flash-outline'" slot="start"></ion-icon>
                  {{ isGeneratingSummary(scene.id) ? 'Generating…' : 'AI Summary' }}
                  <ion-spinner *ngIf="isGeneratingSummary(scene.id)" name="dots" style="width: 14px; height: 14px; margin-left: 6px;"></ion-spinner>
                </ion-button>
                <ion-button *ngIf="!isEditingTitle(scene.id)" size="small" fill="outline" color="medium" (click)="startEditTitle(scene.id, scene.title)" title="Edit title">
                  <ion-icon name="create-outline" slot="start"></ion-icon>
                  Edit Title
                </ion-button>
                <ion-button *ngIf="isEditingTitle(scene.id)" size="small" color="primary" (click)="saveSceneTitle(chapter.id, scene.id)" [disabled]="savingTitle(scene.id)" title="Save title (Enter)">
                  <ion-icon name="save-outline" slot="start"></ion-icon>
                  Save Title
                </ion-button>
                <ion-button *ngIf="isEditingTitle(scene.id)" size="small" fill="outline" color="medium" (click)="cancelEditTitle(scene.id)" [disabled]="savingTitle(scene.id)" title="Cancel">
                  <ion-icon name="close-outline" slot="start"></ion-icon>
                  Cancel
                </ion-button>

                <ion-button *ngIf="!isEditing(scene.id)" size="small" fill="outline" color="medium" (click)="startEdit(scene.id, scene.summary)" title="Edit summary">
                  <ion-icon name="create-outline" slot="start"></ion-icon>
                  Edit Summary
                </ion-button>
                <ion-button *ngIf="isEditing(scene.id)" size="small" color="primary" (click)="saveSceneSummary(chapter.id, scene.id)" [disabled]="saving(scene.id)" title="Save summary (Ctrl+Enter)">
                  <ion-icon name="save-outline" slot="start"></ion-icon>
                  Save
                </ion-button>
                <ion-button *ngIf="isEditing(scene.id)" size="small" fill="outline" color="medium" (click)="cancelEdit(scene.id)" [disabled]="saving(scene.id)" title="Cancel">
                  <ion-icon name="close-outline" slot="start"></ion-icon>
                  Cancel
                </ion-button>
                <ion-button size="small" color="medium" (click)="openInEditor(chapter.id, scene.id)" title="Open in editor">
                  <ion-icon name="open-outline" slot="start"></ion-icon>
                  Open Scene
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-list>
      </div>
    </ion-accordion>
  </ion-accordion-group>

  <div class="empty" *ngIf="!loading() && filteredChapters().length === 0">
    <p>No scenes match your filter.</p>
  </div>
</ion-content>
