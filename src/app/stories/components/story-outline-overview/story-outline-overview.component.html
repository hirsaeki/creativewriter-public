<app-header
  [title]="'Outline Overview'"
  [leftActions]="leftActions"
  [rightActions]="rightActions"
  [showBurgerMenu]="false"
></app-header>

<ion-content [fullscreen]="true">
  <div class="toolbar">
    <ion-searchbar
      placeholder="Search titles and summaries"
      [debounce]="150"
      (ionInput)="query.set($any($event.target).value || '')">
    </ion-searchbar>
    <ion-chip [color]="onlyWithSummary() ? 'primary' : 'medium'" (click)="onlyWithSummary.set(!onlyWithSummary())">
      <ion-label>Only with summary</ion-label>
    </ion-chip>
  </div>

  <div class="story-meta" *ngIf="story() as s">
    <div class="title">{{ s.title || 'Untitled Story' }}</div>
    <div class="meta">{{ s.chapters?.length || 0 }} chapter(s)</div>
  </div>

  <div *ngIf="loading()" class="loading">
    <ion-skeleton-text [animated]="true" style="width: 60%; height: 20px;"></ion-skeleton-text>
    <ion-skeleton-text [animated]="true" style="width: 90%; height: 16px;"></ion-skeleton-text>
    <ion-skeleton-text [animated]="true" style="width: 80%; height: 16px;"></ion-skeleton-text>
  </div>

  <ion-accordion-group *ngIf="!loading()" [multiple]="true" [value]="expandedArray()" (ionChange)="onAccordionChange($event)">
    <ion-accordion *ngFor="let chapter of filteredChapters()" [value]="chapter.id">
      <ion-item slot="header" lines="full">
        <ion-label>
          <div class="chapter-title">
            <span class="idx">{{chapter.chapterNumber}}.</span>
            <span>{{ chapter.title || 'Untitled Chapter' }}</span>
          </div>
          <ion-note>{{ chapter.scenes.length }} scene(s)</ion-note>
        </ion-label>
      </ion-item>
      <div class="chapter-content" slot="content">
        <ion-list lines="none">
          <ion-card *ngFor="let scene of chapter.scenes" class="scene-card">
            <ion-card-header>
              <ion-card-title>
                <span class="idx">{{scene.sceneNumber}}.</span>
                <span>{{ scene.title || 'Untitled Scene' }}</span>
                <ion-badge color="warning" *ngIf="!scene.summary">No summary</ion-badge>
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ng-container *ngIf="!isEditing(scene.id); else editSummaryTpl">
                <div class="summary" [class.placeholder]="!scene.summary">
                  {{ scene.summary || 'No summary available for this scene.' }}
                </div>
              </ng-container>

              <ng-template #editSummaryTpl>
                <div class="summary-edit">
                  <ion-textarea
                    [ngModel]="editingSummaries[scene.id] || ''"
                    (ngModelChange)="onEditSummaryChange(scene.id, $event)"
                    [autoGrow]="true"
                    rows="6"
                    placeholder="Write a short summary for this scene..."
                    (keydown)="onSummaryKeydown($event, chapter.id, scene.id)">
                  </ion-textarea>
                </div>
              </ng-template>

              <div class="actions">
                <ion-button *ngIf="!isEditing(scene.id)" size="small" fill="outline" color="medium" (click)="startEdit(scene.id, scene.summary)" title="Edit summary">
                  <ion-icon name="create-outline" slot="start"></ion-icon>
                  Edit Summary
                </ion-button>
                <ion-button *ngIf="isEditing(scene.id)" size="small" color="primary" (click)="saveSceneSummary(chapter.id, scene.id)" [disabled]="saving(scene.id)" title="Save summary (Ctrl+Enter)">
                  <ion-icon name="save-outline" slot="start"></ion-icon>
                  Save
                </ion-button>
                <ion-button *ngIf="isEditing(scene.id)" size="small" fill="outline" color="medium" (click)="cancelEdit(scene.id)" [disabled]="saving(scene.id)" title="Cancel">
                  <ion-icon name="close-outline" slot="start"></ion-icon>
                  Cancel
                </ion-button>
                <ion-button size="small" color="medium" (click)="openInEditor(chapter.id, scene.id)" title="Open in editor">
                  <ion-icon name="open-outline" slot="start"></ion-icon>
                  Open Scene
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-list>
      </div>
    </ion-accordion>
  </ion-accordion-group>

  <div class="empty" *ngIf="!loading() && filteredChapters().length === 0">
    <p>No scenes match your filter.</p>
  </div>
</ion-content>
