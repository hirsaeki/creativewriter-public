<ion-header>
  <ion-toolbar>
    <ion-title>Beat Version History</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Current Prompt -->
  <div class="current-prompt" *ngIf="currentPrompt">
    <ion-label>
      <strong>Current Prompt:</strong>
    </ion-label>
    <p>{{ currentPrompt }}</p>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="loading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading version history...</p>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="error && !loading">
    <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
    <p>{{ error }}</p>
    <ion-button fill="outline" (click)="loadHistory()">
      Retry
    </ion-button>
  </div>

  <!-- Version List -->
  <div class="version-list" *ngIf="!loading && !error && versions.length > 0">
    <div class="version-list-header">
      <ion-label>
        <strong>Version History</strong> ({{ versions.length }} version{{ versions.length > 1 ? 's' : '' }})
      </ion-label>
    </div>

    <ion-card
      *ngFor="let version of versions; trackBy: trackByVersionId"
      class="version-card">

      <ion-card-header>
        <ion-card-subtitle>
          <div class="version-header">
            <div class="version-info">
              <span class="version-label">{{ formatVersionLabel(version) }}</span>
              <span class="action-badge" [class.rewrite-badge]="version.action === 'rewrite'" [class.generate-badge]="!version.action || version.action === 'generate'" [class.manual-badge]="version.model === 'manual'">
                {{ version.model === 'manual' ? 'PREVIOUS' : (version.action === 'rewrite' ? 'REWRITE' : 'GENERATE') }}
              </span>
            </div>
            <span class="version-timestamp">{{ formatTimestamp(version.generatedAt) }}</span>
          </div>
        </ion-card-subtitle>
        <ion-card-title>
          <div class="model-info">
            <span class="model-name">{{ version.model }}</span>
            <span class="version-meta">{{ version.wordCount }} words • {{ version.characterCount }} chars</span>
          </div>
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <!-- Version Prompt (if different from current) -->
        <div class="version-prompt" *ngIf="version.prompt && version.prompt !== currentPrompt">
          <div class="prompt-content">
            <strong>Prompt:</strong> <em>{{ version.prompt }}</em>
          </div>
          <ion-button
            fill="clear"
            size="small"
            class="copy-btn"
            (click)="copyPrompt(version, $event)"
            [title]="copiedPromptId === version.versionId ? 'Copied!' : 'Copy prompt'">
            <ion-icon
              [name]="copiedPromptId === version.versionId ? 'checkmark-outline' : 'copy-outline'"
              slot="icon-only">
            </ion-icon>
          </ion-button>
        </div>

        <!-- Rewrite Instruction (for rewrites) -->
        <div class="rewrite-instruction-section" *ngIf="version.action === 'rewrite' && version.rewriteInstruction">
          <strong>Rewrite Instruction:</strong>
          <div class="rewrite-instruction-content">
            {{ version.rewriteInstruction }}
          </div>
        </div>

        <!-- Original Text (for rewrites) -->
        <div class="original-text-section" *ngIf="version.action === 'rewrite' && version.existingText">
          <strong>Original Text (Before Rewrite):</strong>
          <div class="original-text-content">
            {{ version.existingText }}
          </div>
        </div>

        <!-- Content Preview -->
        <div class="version-content" [class.expanded]="version.expanded">
          <p class="content-preview" *ngIf="!version.expanded" style="white-space: pre-wrap;">
            {{ getPreview(version.content) }}
          </p>
          <p class="content-full" *ngIf="version.expanded" style="white-space: pre-wrap;">
            {{ getFullText(version.content) }}
          </p>
        </div>

        <!-- Context Info -->
        <div class="context-info" *ngIf="version.selectedScenes && version.selectedScenes.length > 0">
          <small>
            Context: {{ version.selectedScenes.length }} scene(s) selected
            <span *ngIf="version.includeStoryOutline !== undefined">
              • Outline: {{ version.includeStoryOutline ? 'Included' : 'Excluded' }}
            </span>
          </small>
        </div>

        <!-- Staging Notes -->
        <div class="staging-notes-info" *ngIf="version.stagingNotes">
          <strong>Staging Notes:</strong>
          <div class="staging-notes-content">
            {{ version.stagingNotes }}
          </div>
        </div>

        <!-- Actions -->
        <div class="version-actions">
          <ion-button
            size="small"
            fill="clear"
            (click)="toggleExpanded(version)"
            [title]="version.expanded ? 'Show less' : 'View full content'">
            <ion-icon
              [name]="version.expanded ? 'chevron-up' : 'chevron-down'"
              slot="icon-only">
            </ion-icon>
          </ion-button>

          <ion-button
            size="small"
            fill="clear"
            (click)="copyContent(version, $event)"
            [title]="copiedContentId === version.versionId ? 'Copied!' : 'Copy text'">
            <ion-icon
              [name]="copiedContentId === version.versionId ? 'checkmark-outline' : 'copy-outline'"
              slot="icon-only">
            </ion-icon>
          </ion-button>

          <ion-button
            size="small"
            fill="solid"
            (click)="restoreVersion(version)"
            title="Restore this version">
            <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!loading && !error && versions.length === 0">
    <ion-icon name="time-outline"></ion-icon>
    <h3>No Version History</h3>
    <p>Version history will appear here after generating this beat.</p>
  </div>
</ion-content>

<ion-footer>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button
        fill="clear"
        color="danger"
        (click)="deleteHistory()"
        [disabled]="versions.length === 0 || loading">
        <ion-icon name="trash-outline" slot="start"></ion-icon>
        Delete All History
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()">
        Close
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-footer>
