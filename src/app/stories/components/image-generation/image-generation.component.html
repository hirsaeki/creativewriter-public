<div class="ion-page">
  <ion-header>
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-button (click)="goBack()">
          <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-buttons>
      <ion-title>Image Generation</ion-title>
      <ion-buttons slot="end">
        <ion-button (click)="refreshModels()" [disabled]="modelsLoading">
          <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
        </ion-button>
        <ion-button (click)="goToSettings()">
          <ion-icon name="settings-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>

  <ion-content>
    <div class="main-container">
      <!-- Two-column layout -->
      <div class="content-grid">
        <!-- Left Column: Generation Controls -->
        <div class="generation-panel">
          <!-- Provider Selection -->
          <ion-card class="provider-card">
            <ion-card-content>
              <ion-segment [(ngModel)]="selectedProvider" (ionChange)="onProviderChange()">
                <ion-segment-button *ngFor="let provider of providers" [value]="provider"
                  [disabled]="!isProviderConfigured(provider)">
                  <ion-label>{{ getProviderDisplayName(provider) }}</ion-label>
                  <ion-badge *ngIf="isProviderConfigured(provider)" color="primary">
                    {{ getProviderModelCount(provider) }}
                  </ion-badge>
                  <ion-icon *ngIf="!isProviderConfigured(provider)" name="alert-circle-outline" color="medium">
                  </ion-icon>
                </ion-segment-button>
              </ion-segment>

              <!-- Not configured warning -->
              <div *ngIf="!isProviderConfigured(selectedProvider)" class="not-configured-warning">
                <ion-icon name="alert-circle-outline"></ion-icon>
                <span>{{ getProviderDisplayName(selectedProvider) }} is not configured.</span>
                <ion-button fill="clear" size="small" (click)="goToSettings()">
                  Configure
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>

          <!-- Model Selection -->
          <ion-card class="model-card" *ngIf="isProviderConfigured(selectedProvider)">
            <ion-card-header (click)="toggleModelSelector()" (keydown.enter)="toggleModelSelector()"
              class="model-selector-header" role="button" tabindex="0"
              [attr.aria-expanded]="modelSelectorExpanded || !selectedModel">
              <ion-card-title>
                <ion-icon name="sparkles-outline"></ion-icon>
                {{ selectedModel ? 'Model' : 'Select Model' }}
              </ion-card-title>
              <ion-icon [name]="modelSelectorExpanded ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
            </ion-card-header>
            <ion-card-content>
              <!-- Collapsed: Show selected model preview -->
              <div *ngIf="!modelSelectorExpanded && selectedModel" class="selected-model-preview"
                   (click)="toggleModelSelector()" (keydown.enter)="toggleModelSelector()" tabindex="0" role="button">
                <div class="model-info">
                  <h4>{{ selectedModel.name }}</h4>
                  <p>{{ selectedModel.description | slice:0:80 }}{{ selectedModel.description.length > 80 ? '...' : '' }}</p>
                </div>
                <ion-button fill="clear" size="small" (click)="$event.stopPropagation(); toggleModelSelector()">
                  <ion-icon name="swap-horizontal-outline" slot="icon-only"></ion-icon>
                </ion-button>
              </div>

              <!-- Expanded: Show search and model list -->
              <div *ngIf="modelSelectorExpanded || !selectedModel" class="model-selector-expanded">
                <!-- Loading state -->
                <div *ngIf="modelsLoading" class="loading-state">
                  <ion-spinner name="crescent"></ion-spinner>
                  <p>Loading models...</p>
                </div>

                <div *ngIf="!modelsLoading">
                  <!-- Search -->
                  <ion-searchbar [(ngModel)]="modelSearchTerm" (ionInput)="onModelSearch()" placeholder="Search models..."
                    debounce="300">
                  </ion-searchbar>

                  <!-- Model list -->
                  <div class="model-list">
                    <div *ngFor="let model of filteredModels" class="model-item"
                      [class.selected]="selectedModel?.id === model.id" (click)="selectModel(model)"
                      (keydown.enter)="selectModel(model)" tabindex="0" role="option"
                      [attr.aria-selected]="selectedModel?.id === model.id">
                      <div class="model-info">
                        <h4>{{ model.name }}</h4>
                        <p>{{ model.description | slice:0:100 }}{{ model.description.length > 100 ? '...' : '' }}</p>
                      </div>
                      <ion-icon *ngIf="selectedModel?.id === model.id" name="checkmark-circle" color="primary">
                      </ion-icon>
                    </div>

                    <div *ngIf="filteredModels.length === 0" class="no-models">
                      <ion-icon name="cloud-outline"></ion-icon>
                      <p *ngIf="modelSearchTerm">No models found matching "{{ modelSearchTerm }}"</p>
                      <p *ngIf="!modelSearchTerm">No models available for this provider</p>
                    </div>
                  </div>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <!-- Generation Form -->
          <ion-card class="generation-form-card" *ngIf="selectedModel">
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="image-outline"></ion-icon>
                Generate Image
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <!-- Prompt -->
              <div class="form-field">
                <!-- eslint-disable-next-line @angular-eslint/template/label-has-associated-control -->
                <label id="prompt-label">Prompt *</label>
                <ion-textarea [(ngModel)]="prompt" placeholder="Describe the image you want to generate..."
                  [autoGrow]="true" rows="3" aria-labelledby="prompt-label">
                </ion-textarea>
                <span class="char-count">{{ prompt.length }} characters</span>
              </div>

              <!-- Aspect Ratio Selector -->
              <div class="form-field" *ngIf="selectedModel.capabilities.supportsAspectRatio">
                <!-- eslint-disable-next-line @angular-eslint/template/label-has-associated-control -->
                <label id="aspect-ratio-label">Aspect Ratio</label>
                <div class="aspect-ratio-selector" role="group" aria-labelledby="aspect-ratio-label">
                  <button *ngFor="let ratio of aspectRatios" [class.selected]="selectedAspectRatio === ratio.value"
                    (click)="selectedAspectRatio = ratio.value" type="button" [attr.aria-pressed]="selectedAspectRatio === ratio.value">
                    <span class="ratio-label">{{ ratio.label }}</span>
                  </button>
                </div>
              </div>

              <!-- Number of Images -->
              <div class="form-field" *ngIf="selectedModel.capabilities.supportsMultipleImages">
                <!-- eslint-disable-next-line @angular-eslint/template/label-has-associated-control -->
                <label id="num-images-label">Number of Images</label>
                <ion-segment [(ngModel)]="numImages" aria-labelledby="num-images-label">
                  <ion-segment-button [value]="1">1</ion-segment-button>
                  <ion-segment-button [value]="2">2</ion-segment-button>
                  <ion-segment-button [value]="3">3</ion-segment-button>
                  <ion-segment-button [value]="4">4</ion-segment-button>
                </ion-segment>
              </div>

              <!-- Advanced Options Toggle -->
              <ion-button fill="clear" size="small" (click)="toggleAdvancedOptions()" class="advanced-toggle">
                {{ showAdvancedOptions ? 'Hide' : 'Show' }} Advanced Options
                <ion-icon [name]="showAdvancedOptions ? 'chevron-up' : 'chevron-down'" slot="end"></ion-icon>
              </ion-button>

              <!-- Advanced Options -->
              <div *ngIf="showAdvancedOptions" class="advanced-options">
                <!-- Negative Prompt -->
                <div class="form-field" *ngIf="selectedModel.capabilities.supportsNegativePrompt">
                  <!-- eslint-disable-next-line @angular-eslint/template/label-has-associated-control -->
                  <label id="negative-prompt-label">Negative Prompt</label>
                  <ion-textarea [(ngModel)]="negativePrompt" placeholder="What to avoid in the image..." rows="2"
                    aria-labelledby="negative-prompt-label">
                  </ion-textarea>
                </div>

                <!-- Guidance Scale -->
                <div class="form-field" *ngIf="selectedModel.capabilities.supportsGuidanceScale">
                  <!-- eslint-disable-next-line @angular-eslint/template/label-has-associated-control -->
                  <label id="guidance-scale-label">Guidance Scale: {{ guidanceScale }}</label>
                  <ion-range [(ngModel)]="guidanceScale" [min]="1" [max]="20" [step]="0.5" color="primary" [pin]="true"
                    aria-labelledby="guidance-scale-label">
                  </ion-range>
                </div>

                <!-- Inference Steps -->
                <div class="form-field" *ngIf="selectedModel.capabilities.supportsInferenceSteps">
                  <!-- eslint-disable-next-line @angular-eslint/template/label-has-associated-control -->
                  <label id="inference-steps-label">Inference Steps: {{ inferenceSteps }}</label>
                  <ion-range [(ngModel)]="inferenceSteps" [min]="1" [max]="50" [step]="1" color="primary" [pin]="true"
                    aria-labelledby="inference-steps-label">
                  </ion-range>
                </div>

                <!-- Seed -->
                <div class="form-field" *ngIf="selectedModel.capabilities.supportsSeed">
                  <!-- eslint-disable-next-line @angular-eslint/template/label-has-associated-control -->
                  <label id="seed-label">Seed (optional)</label>
                  <ion-input [(ngModel)]="seed" type="number" placeholder="Random seed for reproducibility"
                    aria-labelledby="seed-label">
                  </ion-input>
                </div>

                <!-- Safety Settings (fal.ai only) -->
                <div class="form-field safety-settings" *ngIf="selectedProvider === 'fal'">
                  <!-- eslint-disable-next-line @angular-eslint/template/label-has-associated-control -->
                  <label id="safety-label">Safety Filter</label>
                  <div class="safety-toggle">
                    <ion-segment [(ngModel)]="enableSafetyChecker" aria-labelledby="safety-label">
                      <ion-segment-button [value]="true">Enabled</ion-segment-button>
                      <ion-segment-button [value]="false">Disabled</ion-segment-button>
                    </ion-segment>
                  </div>

                  <!-- Safety Tolerance (only when enabled) -->
                  <div *ngIf="enableSafetyChecker" class="safety-tolerance">
                    <!-- eslint-disable-next-line @angular-eslint/template/label-has-associated-control -->
                    <label id="tolerance-label">Safety Tolerance: {{ safetyTolerance }} (1=strict, 5=permissive)</label>
                    <ion-range [(ngModel)]="safetyTolerance" [min]="1" [max]="5" [step]="1" [snaps]="true" [ticks]="true"
                      color="primary" [pin]="true" aria-labelledby="tolerance-label">
                    </ion-range>
                  </div>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </div>

        <!-- Right Column: History -->
        <div class="history-panel">
          <ion-card class="history-card">
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="time-outline"></ion-icon>
                History
              </ion-card-title>
              <ion-button *ngIf="jobs.length > 0" fill="clear" size="small" (click)="clearHistory()">
                <ion-icon name="trash-outline" slot="start"></ion-icon>
                Clear
              </ion-button>
            </ion-card-header>
            <ion-card-content>
              <!-- Empty state -->
              <div *ngIf="jobs.length === 0" class="empty-history">
                <ion-icon name="image-outline"></ion-icon>
                <p>No images generated yet</p>
                <p class="sub-text">Your generated images will appear here</p>
              </div>

              <!-- Jobs list -->
              <div class="jobs-grid">
                <div *ngFor="let job of jobs" class="job-item">
                  <!-- Status badge -->
                  <div class="job-header">
                    <ion-chip [color]="getStatusColor(job.status)" size="small">
                      <ion-icon [name]="getStatusIcon(job.status)"></ion-icon>
                      {{ getStatusText(job.status) }}
                    </ion-chip>
                    <span class="job-model">{{ job.modelName }}</span>
                    <span class="job-date">{{ formatDate(job.createdAt) }}</span>
                  </div>

                  <!-- Processing indicator -->
                  <div *ngIf="job.status === 'processing'" class="processing-indicator">
                    <ion-progress-bar type="indeterminate" color="primary"></ion-progress-bar>
                  </div>

                  <!-- Image display -->
                  <div *ngIf="job.status === 'completed' && getJobImages(job).length > 0" class="job-images">
                    <div *ngFor="let image of getJobImages(job); let i = index" class="image-wrapper">
                      <img [src]="image.url" [alt]="job.prompt" (click)="openGallery(job, i)"
                        (keydown.enter)="openGallery(job, i)" tabindex="0" role="button" loading="lazy" />
                      <div class="image-overlay">
                        <ion-button fill="clear" size="small" (click)="downloadImage(image.url, job.prompt + '_' + i); $event.stopPropagation()">
                          <ion-icon name="download-outline" slot="icon-only"></ion-icon>
                        </ion-button>
                      </div>
                    </div>
                  </div>

                  <!-- Error display -->
                  <div *ngIf="job.status === 'failed'" class="job-error">
                    <ion-icon name="alert-circle-outline"></ion-icon>
                    <p>{{ job.error }}</p>
                  </div>

                  <!-- Prompt and actions -->
                  <div class="job-footer">
                    <p class="job-prompt" [title]="job.prompt">{{ job.prompt | slice:0:100 }}{{ job.prompt.length > 100 ?
                      '...' : '' }}</p>
                    <div class="job-actions">
                      <ion-button fill="clear" size="small" (click)="restoreSettings(job)" title="Restore settings">
                        <ion-icon name="arrow-undo-outline" slot="icon-only"></ion-icon>
                      </ion-button>
                      <ion-button fill="clear" size="small" (click)="copyPrompt(job.prompt)" title="Copy prompt">
                        <ion-icon name="copy-outline" slot="icon-only"></ion-icon>
                      </ion-button>
                      <ion-button *ngIf="job.status === 'processing'" fill="clear" size="small" color="danger"
                        (click)="cancelJob(job.id)" title="Cancel">
                        <ion-icon name="close-circle-outline" slot="icon-only"></ion-icon>
                      </ion-button>
                      <ion-button *ngIf="job.status !== 'processing'" fill="clear" size="small"
                        (click)="regenerateAndAppend(job)" title="Regenerate"
                        [disabled]="job.status !== 'completed' || processingCount >= 3">
                        <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
                      </ion-button>
                      <ion-button fill="clear" size="small" color="danger" (click)="deleteJob(job.id)" title="Delete"
                        [disabled]="job.status === 'processing'">
                        <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                      </ion-button>
                    </div>
                  </div>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </div>
      </div>
    </div>

    <!-- Generate FAB -->
    <ion-fab slot="fixed" vertical="bottom" horizontal="end" *ngIf="selectedModel" class="generate-fab">
      <ion-fab-button (click)="generateImage()"
        [disabled]="!prompt.trim() || processingCount >= 3" color="primary"
        [attr.aria-label]="processingCount >= 3 ? 'Maximum concurrent generations reached' : 'Generate image'">
        <ion-icon name="sparkles-outline" aria-hidden="true"></ion-icon>
      </ion-fab-button>
      <ion-badge *ngIf="processingCount > 0" color="warning" class="processing-badge">
        {{ processingCount }}
      </ion-badge>
    </ion-fab>

    <!-- Toast -->
    <ion-toast [isOpen]="showToast" [message]="toastMessage" [duration]="3000" [color]="toastColor"
      (didDismiss)="showToast = false">
    </ion-toast>

    <!-- Image Gallery Modal -->
    <app-image-gallery-modal
      [isOpen]="showGallery"
      [images]="galleryImages"
      [initialIndex]="galleryInitialIndex"
      [prompt]="galleryPrompt"
      (closed)="showGallery = false">
    </app-image-gallery-modal>
  </ion-content>
</div>
