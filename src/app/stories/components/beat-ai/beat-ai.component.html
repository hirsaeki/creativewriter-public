    <div class="beat-ai-container" [class.expanded]="!beatData.isCollapsed" [class.collapsed]="beatData.isCollapsed" [class.generating]="beatData.isGenerating" [style.--beat-ai-text-color]="currentTextColor">
      <!-- Prompt Input Section -->
      <div class="beat-prompt-section" [class.collapsed]="beatData.isCollapsed">
        <div class="beat-header">
          <div class="beat-icon">
            <ion-icon name="color-wand-outline"></ion-icon>
          </div>
          <div class="beat-title">Beat AI</div>
          <ion-chip *ngIf="beatData.lastAction === 'rewrite'" color="warning" class="rewrite-indicator">
            <ion-icon name="create-outline"></ion-icon>
            <ion-label>Rewrite</ion-label>
          </ion-chip>
          <div class="beat-actions">
            <button
              class="action-btn collapse-btn"
              (click)="toggleCollapsed($event)"
              [attr.title]="beatData.isCollapsed ? 'Expand prompt' : 'Collapse prompt'">
              <ion-icon [name]="beatData.isCollapsed ? 'chevron-down' : 'chevron-up'"></ion-icon>
            </button>
            <div class="button-group" *ngIf="!beatData.isCollapsed">
              <button
                class="action-btn context-btn group-left"
                (click)="showSceneSelector = true; $event.stopPropagation()"
                title="Select context">
                <ion-icon name="add-outline"></ion-icon>
              </button>
              <button
                class="action-btn outline-btn group-right"
                [class.active]="includeStoryOutline"
                (click)="toggleStoryOutline(); $event.stopPropagation()"
                title="Include/exclude story overview">
                <ion-icon name="reader-outline"></ion-icon>
              </button>
            </div>
            <div class="button-group" *ngIf="beatData.generatedContent && !beatData.isGenerating">
              <button
                class="action-btn regenerate-btn group-left"
                (click)="regenerateContent(); $event.stopPropagation()"
                title="Regenerate">
                <ion-icon name="refresh-outline"></ion-icon>
              </button>
              <button
                class="action-btn rewrite-btn group-right"
                (click)="rewriteContent(); $event.stopPropagation()"
                title="Rewrite with custom prompt">
                <ion-icon name="create-outline"></ion-icon>
              </button>
            </div>
            <button
              *ngIf="beatData.hasHistory"
              class="action-btn history-btn"
              (click)="openVersionHistory(); $event.stopPropagation()"
              title="Version History">
              <ion-icon name="time-outline"></ion-icon>
            </button>
            <div class="button-group">
              <button
                class="action-btn delete-btn group-left"
                (click)="deleteContentAfterBeat(); $event.stopPropagation()"
                title="Delete text until next beat or scene end">
                <ion-icon name="trash-outline"></ion-icon>
              </button>
              <button
                class="action-btn remove-btn group-right"
                (click)="removeBeat($event)"
                title="Remove this beat input">
                <ion-icon name="close-circle-outline"></ion-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Context Chips -->
        <div class="context-chips" *ngIf="!beatData.isCollapsed && (selectedScenes.length > 0 || includeStoryOutline)">
          <ion-chip *ngIf="includeStoryOutline" color="success">
            <ion-label>Story Overview</ion-label>
            <ion-icon
              name="close-outline"
              (click)="removeStoryOutline(); $event.stopPropagation()">
            </ion-icon>
          </ion-chip>
          <ion-chip
            *ngFor="let scene of selectedScenes"
            [color]="scene.sceneId === sceneId ? 'primary' : 'medium'"
            [class.truncated-scene]="scene.isTruncated"
            [title]="scene.isTruncated ? 'This scene context is truncated at the current beat position - only text before this beat is included' : ''">
            <ion-label>{{ scene.chapterTitle }} - {{ scene.sceneTitle }}</ion-label>
            <ion-icon
              name="close-outline"
              (click)="removeSceneContext(scene); $event.stopPropagation()">
            </ion-icon>
          </ion-chip>
        </div>
        
        <div class="prompt-input-container" *ngIf="!beatData.isCollapsed">
          <div
            #promptInput
            class="prompt-input prosemirror-container"
          ></div>
          
          <!-- Generation Options -->
          <div class="generation-options" *ngIf="!beatData.isCollapsed">
            <div class="options-row">
              <!-- Favorite Models Quick Access -->
              <div class="favorite-models" *ngIf="favoriteModels.length > 0">
                <ion-icon name="star-outline" class="favorite-icon" aria-hidden="true"></ion-icon>
                <div class="favorite-buttons" role="list">
                  <button *ngFor="let model of favoriteModels"
                          type="button"
                          class="favorite-btn"
                          role="listitem"
                          [class.active]="selectedModel === model.id"
                          (click)="selectFavoriteModel(model)"
                          [title]="'Select ' + model.label"
                          [attr.aria-label]="'Select ' + model.label"
                          [attr.aria-pressed]="selectedModel === model.id">
                    <span class="favorite-btn-content">
                      <app-openrouter-icon *ngIf="model.provider === 'openrouter'" size="14" color="#6467f2" class="provider-icon-inline openrouter"></app-openrouter-icon>
                      <ion-icon *ngIf="model.provider !== 'openrouter'" [name]="getProviderIcon(model.provider)" class="provider-icon-inline" [class.gemini]="model.provider === 'gemini'"></ion-icon>
                      <span class="model-short-name">{{ model.label }}</span>
                    </span>
                  </button>
                </div>
              </div>
              <div class="option-group">
                <ng-select [(ngModel)]="selectedBeatType"
                           [items]="beatTypeOptions"
                           bindLabel="label"
                           bindValue="value"
                           [clearable]="false"
                           [searchable]="false"
                           placeholder="Choose beat type..."
                           class="model-select beat-type-select"
                           (change)="onBeatTypeChange()">
                  <ng-template ng-option-tmp let-item="item">
                    <div class="beat-type-option">
                      <span class="beat-type-label">{{ item.label }}</span>
                      <span class="beat-type-description">{{ item.description }}</span>
                    </div>
                  </ng-template>
                </ng-select>
              </div>
              <div class="option-group">
                <ng-select [(ngModel)]="selectedWordCount"
                           [items]="wordCountOptions"
                           bindLabel="label"
                           bindValue="value"
                           [clearable]="false"
                           [searchable]="false"
                           placeholder="Choose word count..."
                           class="model-select word-count-select"
                           (change)="onWordCountChange()">
                </ng-select>
                <input 
                  *ngIf="showCustomWordCount"
                  type="number"
                  [(ngModel)]="customWordCount"
                  class="custom-word-count"
                  placeholder="Anzahl eingeben..."
                  min="10"
                  max="50000"
                  (blur)="validateCustomWordCount()">
              </div>
              <div class="option-group model-selection-group">
                <ng-select [(ngModel)]="selectedModel"
                           [items]="availableModels"
                           bindLabel="label"
                           bindValue="id"
                           [clearable]="false"
                           [searchable]="true"
                           placeholder="Select model..."
                           class="model-select ai-model-select"
                           (change)="onModelChange()">
                  <ng-template ng-label-tmp let-item="item">
                    <div class="model-option-inline">
                      <app-openrouter-icon *ngIf="item.provider === 'openrouter'" size="16" color="#6467f2" class="provider-icon-inline openrouter"></app-openrouter-icon>
                      <app-claude-icon *ngIf="item.provider === 'claude'" size="16" color="#C15F3C" class="provider-icon-inline claude"></app-claude-icon>
                      <app-replicate-icon *ngIf="item.provider === 'replicate'" size="16" color="#9c27b0" class="provider-icon-inline replicate"></app-replicate-icon>
                      <app-ollama-icon *ngIf="item.provider === 'ollama'" size="16" color="#ff9800" class="provider-icon-inline ollama"></app-ollama-icon>
                      <ion-icon *ngIf="item.provider !== 'openrouter' && item.provider !== 'claude' && item.provider !== 'replicate' && item.provider !== 'ollama'" [name]="getProviderIcon(item.provider)" class="provider-icon-inline" [class.gemini]="item.provider === 'gemini'"></ion-icon>
                      <span class="model-label">{{ item.label }}</span>
                      <button class="favorite-toggle"
                              (click)="toggleFavorite($event, item)"
                              [class.is-favorite]="isFavorite(item.id)"
                              title="Mark as favorite">
                        ⭐
                      </button>
                    </div>
                  </ng-template>
                  <ng-template ng-option-tmp let-item="item">
                    <div class="model-option-inline">
                      <app-openrouter-icon *ngIf="item.provider === 'openrouter'" size="16" color="#6467f2" class="provider-icon-inline openrouter"></app-openrouter-icon>
                      <app-claude-icon *ngIf="item.provider === 'claude'" size="16" color="#C15F3C" class="provider-icon-inline claude"></app-claude-icon>
                      <app-replicate-icon *ngIf="item.provider === 'replicate'" size="16" color="#9c27b0" class="provider-icon-inline replicate"></app-replicate-icon>
                      <app-ollama-icon *ngIf="item.provider === 'ollama'" size="16" color="#ff9800" class="provider-icon-inline ollama"></app-ollama-icon>
                      <ion-icon *ngIf="item.provider !== 'openrouter' && item.provider !== 'claude' && item.provider !== 'replicate' && item.provider !== 'ollama'" [name]="getProviderIcon(item.provider)" class="provider-icon-inline" [class.gemini]="item.provider === 'gemini'"></ion-icon>
                      <span class="model-label">{{ item.label }}</span>
                      <button class="favorite-toggle"
                              (click)="toggleFavorite($event, item)"
                              [class.is-favorite]="isFavorite(item.id)"
                              title="Mark as favorite">
                        ⭐
                      </button>
                    </div>
                  </ng-template>
                </ng-select>
              </div>
            </div>
          </div>

          <div class="prompt-actions" *ngIf="!beatData.isCollapsed">
            <button 
              class="generate-btn primary"
              (click)="generateContent(); $event.stopPropagation()"
              [disabled]="!currentPrompt.trim() || beatData.isGenerating || !selectedModel || isSaving"
              title="Generate content">
              <ion-icon name="color-wand-outline" style="color: #28a745;"></ion-icon>
            </button>
            <button 
              class="generate-btn primary"
              (click)="showPromptPreview(); $event.stopPropagation()"
              [disabled]="!currentPrompt.trim() || isSaving"
              title="Show prompt preview">
              <ion-icon name="eye-outline" style="color: #ffc107;"></ion-icon>
            </button>
            <button 
              class="generate-btn secondary"
              (click)="showTokenInfo(); $event.stopPropagation()"
              [disabled]="!currentPrompt.trim() || !selectedModel"
              title="Token-Analyse anzeigen">
              <ion-icon name="analytics-outline"></ion-icon>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Generation Status -->
      <div class="generation-status" *ngIf="beatData.isGenerating">
        <div class="generation-indicator">
          <span class="generating-text">Text wird gestreamt...</span>
          <div class="typing-indicator">
            <span></span><span></span><span></span>
          </div>
        </div>
        <button 
          class="stop-btn"
          (click)="stopGeneration(); $event.stopPropagation()"
          title="Stop generation">
          ⏹️ Stop
        </button>
      </div>
    </div>


    <!-- Scene Selector Modal -->
    <ion-modal [isOpen]="showSceneSelector" (didDismiss)="showSceneSelector = false">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Add Scenes as Context</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="showSceneSelector = false">
                <ion-icon name="close-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <ion-searchbar 
            [(ngModel)]="sceneSearchTerm" 
            placeholder="Search scene..."
            animated="true">
          </ion-searchbar>
          
          <ion-list>
            <div *ngFor="let chapter of story?.chapters">
              <ion-item-divider>
                <ion-label>C{{ chapter.chapterNumber || chapter.order }}:{{ chapter.title }}</ion-label>
              </ion-item-divider>
              <ion-item 
                *ngFor="let scene of getFilteredScenes(chapter)" 
                [button]="true"
                (click)="toggleSceneSelection(chapter.id, scene.id)">
                <ion-checkbox 
                  slot="start" 
                  [checked]="isSceneSelected(scene.id)">
                </ion-checkbox>
                <ion-label>
                  <h3>C{{ chapter.chapterNumber || chapter.order }}S{{ scene.sceneNumber || scene.order }}:{{ scene.title }}</h3>
                  <p>{{ getScenePreview(scene) }}</p>
                </ion-label>
              </ion-item>
            </div>
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-modal>
