    <div class="beat-ai-container" [class.expanded]="!beatData.isCollapsed" [class.collapsed]="beatData.isCollapsed" [class.generating]="beatData.isGenerating" [style.--beat-ai-text-color]="currentTextColor">
      <!-- Prompt Input Section -->
      <div class="beat-prompt-section" [class.collapsed]="beatData.isCollapsed">
        <div class="beat-header">
          <div class="beat-icon">
            <ion-icon name="color-wand-outline"></ion-icon>
          </div>
          <div class="beat-title">Beat AI</div>
          <ion-chip *ngIf="beatData.lastAction === 'rewrite'" color="warning" class="rewrite-indicator">
            <ion-icon name="create-outline"></ion-icon>
            <ion-label>Rewrite</ion-label>
          </ion-chip>
          <div class="beat-actions">
            <button
              class="cw-btn-glass-primary collapse-btn"
              (click)="toggleCollapsed($event)"
              [attr.title]="beatData.isCollapsed ? 'Expand prompt' : 'Collapse prompt'"
              [attr.aria-label]="beatData.isCollapsed ? 'Expand prompt' : 'Collapse prompt'"
              [attr.aria-expanded]="!beatData.isCollapsed">
              <ion-icon [name]="beatData.isCollapsed ? 'chevron-down' : 'chevron-up'" aria-hidden="true"></ion-icon>
            </button>
            <div class="cw-btn-glass-group" *ngIf="!beatData.isCollapsed">
              <button
                class="cw-btn-glass-primary"
                (click)="showSceneSelector = true; $event.stopPropagation()"
                title="Select context"
                aria-label="Select context">
                <ion-icon name="add-outline" aria-hidden="true"></ion-icon>
              </button>
              <button
                class="cw-btn-glass-success"
                [class.active]="includeStoryOutline"
                (click)="toggleStoryOutline(); $event.stopPropagation()"
                title="Include/exclude story overview"
                aria-label="Include/exclude story overview"
                [attr.aria-pressed]="includeStoryOutline">
                <ion-icon name="reader-outline" aria-hidden="true"></ion-icon>
              </button>
            </div>
            <button
              *ngIf="beatData.hasHistory"
              class="cw-btn-glass-primary"
              (click)="openVersionHistory(); $event.stopPropagation()"
              title="Version History"
              aria-label="Version History">
              <ion-icon name="time-outline" aria-hidden="true"></ion-icon>
            </button>
            <div class="cw-btn-glass-group">
              <button
                class="cw-btn-glass-danger"
                (click)="deleteContentAfterBeat(); $event.stopPropagation()"
                title="Delete text until next beat or scene end"
                aria-label="Delete text until next beat or scene end">
                <ion-icon name="trash-outline" aria-hidden="true"></ion-icon>
              </button>
              <button
                class="cw-btn-glass-danger"
                (click)="removeBeat($event)"
                title="Remove this beat input"
                aria-label="Remove this beat input">
                <ion-icon name="close-circle-outline" aria-hidden="true"></ion-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Context Chips -->
        <div class="context-chips" *ngIf="!beatData.isCollapsed && (selectedScenes.length > 0 || includeStoryOutline)">
          <ion-chip *ngIf="includeStoryOutline" color="success">
            <ion-label>Story Overview</ion-label>
            <ion-icon
              name="close-outline"
              (click)="removeStoryOutline(); $event.stopPropagation()">
            </ion-icon>
          </ion-chip>
          <ion-chip
            *ngFor="let scene of selectedScenes"
            [color]="scene.sceneId === sceneId ? 'primary' : 'medium'"
            [class.truncated-scene]="scene.isTruncated"
            [title]="scene.isTruncated ? 'This scene context is truncated at the current beat position - only text before this beat is included' : ''">
            <ion-label>{{ scene.chapterTitle }} - {{ scene.sceneTitle }}</ion-label>
            <ion-icon
              name="close-outline"
              (click)="removeSceneContext(scene); $event.stopPropagation()">
            </ion-icon>
          </ion-chip>
        </div>

        <!-- Staging Notes Section -->
        <div class="staging-notes-section" *ngIf="!beatData.isCollapsed">
          <div class="staging-notes-header" (click)="toggleStagingNotes()" (keydown.enter)="toggleStagingNotes()" tabindex="0" role="button" [attr.aria-expanded]="isStagingNotesExpanded">
            <ion-icon [name]="isStagingNotesExpanded ? 'chevron-up' : 'chevron-down'" class="collapse-icon"></ion-icon>
            <span class="staging-notes-label">Staging Notes</span>
            <button
              class="cw-btn-glass-primary staging-notes-generate-btn"
              (click)="generateStagingNotes(); $event.stopPropagation()"
              (keydown.enter)="generateStagingNotes(); $event.stopPropagation()"
              [disabled]="isGeneratingStagingNotes"
              title="Generate staging notes from scene content"
              tabindex="0">
              <ion-icon *ngIf="!isGeneratingStagingNotes" name="sparkles-outline"></ion-icon>
              <ion-icon *ngIf="isGeneratingStagingNotes" name="sync-outline" class="spinning"></ion-icon>
            </button>
            <ion-icon name="information-circle-outline"
                      class="info-icon"
                      title="Meta-context for physical consistency (character positions, object placements, scene setup)">
            </ion-icon>
            <ion-chip *ngIf="currentStagingNotes.trim()" size="small" color="tertiary" class="staging-notes-chip">
              {{ currentStagingNotes.length }} chars
            </ion-chip>
          </div>
          <div class="staging-notes-content" *ngIf="isStagingNotesExpanded">
            <textarea
              [(ngModel)]="currentStagingNotes"
              (input)="onStagingNotesChange()"
              placeholder="Describe scene setup, character positions, object locations, or other physical/contextual details that should influence the generated text..."
              rows="4"
              class="staging-notes-textarea">
            </textarea>
            <div class="staging-notes-hint">
              These notes provide physical and contextual context without being written into the story.
            </div>
          </div>
        </div>

        <div class="prompt-input-container" *ngIf="!beatData.isCollapsed">
          <div
            #promptInput
            class="prompt-input prosemirror-container"
          ></div>
          
          <!-- Generation Options -->
          <div class="generation-options" *ngIf="!beatData.isCollapsed">
            <div class="options-row">
              <!-- Favorite Models Quick Access -->
              <div class="favorite-models" *ngIf="favoriteModels.length > 0">
                <ion-icon name="star-outline" class="favorite-icon" aria-hidden="true"></ion-icon>
                <button type="button"
                        class="scroll-arrow scroll-arrow-left"
                        (click)="scrollFavorites('left')"
                        [class.hidden]="!canScrollLeft"
                        [disabled]="!canScrollLeft"
                        aria-label="Scroll left">
                  <ion-icon name="chevron-back-outline"></ion-icon>
                </button>
                <div class="favorite-buttons" role="list" #favoriteButtonsContainer (scroll)="onFavoritesScroll()">
                  <button *ngFor="let model of favoriteModels"
                          type="button"
                          class="favorite-btn"
                          role="listitem"
                          [class.active]="selectedModel === model.id"
                          (click)="selectFavoriteModel(model)"
                          [title]="'Select ' + model.label"
                          [attr.aria-label]="'Select ' + model.label"
                          [attr.aria-pressed]="selectedModel === model.id">
                    <span class="favorite-btn-content">
                      <app-provider-icon
                        [provider]="model.provider"
                        [size]="14"
                        class="provider-icon-inline"
                        [class.openrouter]="model.provider === 'openrouter'"
                        [class.gemini]="model.provider === 'gemini'">
                      </app-provider-icon>
                      <span class="model-short-name">{{ model.label }}</span>
                    </span>
                  </button>
                </div>
                <button type="button"
                        class="scroll-arrow scroll-arrow-right"
                        (click)="scrollFavorites('right')"
                        [class.hidden]="!canScrollRight"
                        [disabled]="!canScrollRight"
                        aria-label="Scroll right">
                  <ion-icon name="chevron-forward-outline"></ion-icon>
                </button>
              </div>
              <div class="option-group">
                <ng-select [(ngModel)]="beatData.beatType"
                           [items]="beatTypeOptions"
                           bindLabel="label"
                           bindValue="value"
                           [clearable]="false"
                           [searchable]="false"
                           placeholder="Choose beat type..."
                           class="model-select beat-type-select"
                           (change)="onBeatTypeChange()">
                  <ng-template ng-option-tmp let-item="item">
                    <div class="beat-type-option">
                      <span class="beat-type-label">{{ item.label }}</span>
                      <span class="beat-type-description">{{ item.description }}</span>
                    </div>
                  </ng-template>
                </ng-select>
              </div>
              <div class="option-group">
                <ng-select [(ngModel)]="selectedWordCount"
                           [items]="wordCountOptions"
                           bindLabel="label"
                           bindValue="value"
                           [clearable]="false"
                           [searchable]="false"
                           placeholder="Choose word count..."
                           class="model-select word-count-select"
                           (change)="onWordCountChange()">
                </ng-select>
                <input 
                  *ngIf="showCustomWordCount"
                  type="number"
                  [(ngModel)]="customWordCount"
                  class="custom-word-count"
                  placeholder="Anzahl eingeben..."
                  min="10"
                  max="50000"
                  (blur)="validateCustomWordCount()">
              </div>
              <div class="option-group model-selection-group">
                <ng-select [(ngModel)]="selectedModel"
                           [items]="availableModels"
                           bindLabel="label"
                           bindValue="id"
                           [clearable]="false"
                           [searchable]="true"
                           placeholder="Select model..."
                           class="model-select ai-model-select"
                           (change)="onModelChange()">
                  <ng-template ng-label-tmp let-item="item">
                    <div class="model-option-inline">
                      <app-provider-icon
                        [provider]="item.provider"
                        [size]="16"
                        class="provider-icon-inline"
                        [class.openrouter]="item.provider === 'openrouter'"
                        [class.claude]="item.provider === 'claude'"
                        [class.replicate]="item.provider === 'replicate'"
                        [class.ollama]="item.provider === 'ollama'"
                        [class.gemini]="item.provider === 'gemini'">
                      </app-provider-icon>
                      <span class="model-label">{{ item.label }}</span>
                      <button class="favorite-toggle"
                              (click)="toggleFavorite($event, item)"
                              [class.is-favorite]="isFavorite(item.id)"
                              title="Mark as favorite">
                        ⭐
                      </button>
                    </div>
                  </ng-template>
                  <ng-template ng-option-tmp let-item="item">
                    <div class="model-option-inline">
                      <app-provider-icon
                        [provider]="item.provider"
                        [size]="16"
                        class="provider-icon-inline"
                        [class.openrouter]="item.provider === 'openrouter'"
                        [class.claude]="item.provider === 'claude'"
                        [class.replicate]="item.provider === 'replicate'"
                        [class.ollama]="item.provider === 'ollama'"
                        [class.gemini]="item.provider === 'gemini'">
                      </app-provider-icon>
                      <span class="model-label">{{ item.label }}</span>
                      <button class="favorite-toggle"
                              (click)="toggleFavorite($event, item)"
                              [class.is-favorite]="isFavorite(item.id)"
                              title="Mark as favorite">
                        ⭐
                      </button>
                    </div>
                  </ng-template>
                </ng-select>
              </div>
            </div>
          </div>

          <div class="prompt-actions" *ngIf="!beatData.isCollapsed">
            <button
              class="cw-btn-glass-success generate-btn-primary"
              (click)="generateContent(); $event.stopPropagation()"
              [disabled]="!currentPrompt.trim() || beatData.isGenerating || !selectedModel || isSaving"
              title="Generate content"
              aria-label="Generate content">
              <ion-icon name="color-wand-outline" aria-hidden="true"></ion-icon>
            </button>
            <!-- Regenerate button - always regenerates from original prompt -->
            <button
              *ngIf="beatData.generatedContent && !beatData.isGenerating"
              class="cw-btn-glass-success"
              (click)="regenerateFromPrompt(); $event.stopPropagation()"
              title="Regenerate from beat prompt"
              aria-label="Regenerate from beat prompt">
              <ion-icon name="refresh-outline" aria-hidden="true"></ion-icon>
            </button>
            <button
              *ngIf="beatData.generatedContent && !beatData.isGenerating"
              class="cw-btn-glass-primary"
              (click)="rewriteContent(); $event.stopPropagation()"
              title="Rewrite with custom prompt"
              aria-label="Rewrite with custom prompt">
              <ion-icon name="create-outline" aria-hidden="true"></ion-icon>
            </button>
            <button
              class="cw-btn-glass-primary"
              (click)="showPromptPreview(); $event.stopPropagation()"
              [disabled]="!currentPrompt.trim() || isSaving"
              title="Show prompt preview"
              aria-label="Show prompt preview">
              <ion-icon name="eye-outline" aria-hidden="true"></ion-icon>
            </button>
            <button
              class="cw-btn-glass-warning"
              (click)="showTokenInfo(); $event.stopPropagation()"
              [disabled]="!currentPrompt.trim() || !selectedModel"
              title="Show token analysis"
              aria-label="Show token analysis">
              <ion-icon name="analytics-outline" aria-hidden="true"></ion-icon>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Generation Status -->
      <div class="generation-status" *ngIf="beatData.isGenerating">
        <div class="generation-indicator">
          <span class="generating-text">Streaming text...</span>
          <div class="typing-indicator">
            <span></span><span></span><span></span>
          </div>
        </div>
        <button
          class="cw-btn-glass-danger"
          (click)="stopGeneration(); $event.stopPropagation()"
          title="Stop generation"
          aria-label="Stop generation">
          <ion-icon name="stop-outline" aria-hidden="true"></ion-icon>
        </button>
      </div>
    </div>


    <!-- Scene Selector Modal -->
    <ion-modal [isOpen]="showSceneSelector" (didDismiss)="showSceneSelector = false">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Add Scenes as Context</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="showSceneSelector = false">
                <ion-icon name="close-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <ion-searchbar 
            [(ngModel)]="sceneSearchTerm" 
            placeholder="Search scene..."
            animated="true">
          </ion-searchbar>
          
          <ion-list>
            <div *ngFor="let chapter of story?.chapters">
              <ion-item-divider>
                <ion-label>C{{ chapter.chapterNumber || chapter.order }}:{{ chapter.title }}</ion-label>
              </ion-item-divider>
              <ion-item 
                *ngFor="let scene of getFilteredScenes(chapter)" 
                [button]="true"
                (click)="toggleSceneSelection(chapter.id, scene.id)">
                <ion-checkbox 
                  slot="start" 
                  [checked]="isSceneSelected(scene.id)">
                </ion-checkbox>
                <ion-label>
                  <h3>C{{ chapter.chapterNumber || chapter.order }}S{{ scene.sceneNumber || scene.order }}:{{ scene.title }}</h3>
                  <p>{{ getScenePreview(scene) }}</p>
                </ion-label>
              </ion-item>
            </div>
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-modal>
