<div class="ion-page">
  <app-header 
    title="Scene Chat" 
    [showBackButton]="true"
    [backAction]="goBack.bind(this)"
    [rightActions]="headerActions"
    [showSecondaryToolbar]="true"
    [secondaryContent]="modelToolbar">
  </app-header>
  
  <ng-template #modelToolbar>
    <div class="model-selection-container">
      <ng-select [(ngModel)]="selectedModel"
                 [items]="availableModels"
                 bindLabel="label"
                 bindValue="id"
                 [clearable]="false"
                 [searchable]="true"
                 placeholder="Select model..."
                 class="model-select"
                 appendTo="body">
        <ng-template ng-option-tmp let-item="item">
          <div class="model-option-inline">
            <app-openrouter-icon 
              *ngIf="item.provider === 'openrouter'"
              size="16" 
              color="#6467f2" 
              class="provider-icon-inline openrouter">
            </app-openrouter-icon>
            <app-claude-icon 
              *ngIf="item.provider === 'claude'"
              size="16" 
              color="#C15F3C" 
              class="provider-icon-inline claude">
            </app-claude-icon>
            <app-replicate-icon 
              *ngIf="item.provider === 'replicate'"
              size="16" 
              color="#9c27b0" 
              class="provider-icon-inline replicate">
            </app-replicate-icon>
            <app-ollama-icon 
              *ngIf="item.provider === 'ollama'"
              size="16" 
              color="#ff9800" 
              class="provider-icon-inline ollama">
            </app-ollama-icon>
            <ion-icon 
              *ngIf="item.provider !== 'openrouter' && item.provider !== 'claude' && item.provider !== 'replicate' && item.provider !== 'ollama'"
              [name]="getProviderIcon(item.provider)" 
              class="provider-icon-inline" 
              [class.gemini]="item.provider === 'gemini'">
            </ion-icon>
            <span class="model-label">{{ item.label }}</span>
          </div>
        </ng-template>
      </ng-select>
    </div>
  </ng-template>
  
  <ion-content class="chat-content" [scrollEvents]="true">
    <div class="context-chips" *ngIf="selectedScenes.length > 0 || includeStoryOutline">
      <ion-chip *ngIf="includeStoryOutline" color="success">
        <ion-label>Story Overview</ion-label>
        <ion-icon 
          name="close-outline" 
          (click)="includeStoryOutline = false">
        </ion-icon>
      </ion-chip>
      <ion-chip *ngFor="let scene of selectedScenes" [color]="scene.sceneId === activeSceneId ? 'primary' : 'medium'">
        <ion-label>{{ scene.chapterTitle }} - {{ scene.sceneTitle }}</ion-label>
        <ion-icon 
          name="close-outline" 
          (click)="removeSceneContext(scene)">
        </ion-icon>
      </ion-chip>
    </div>

    <div class="chat-messages" #scrollContainer>
      <div *ngFor="let message of messages" 
           class="message" 
           [class.user-message]="message.role === 'user'"
           [class.assistant-message]="message.role === 'assistant'">
        <div class="message-avatar">
          <ion-avatar>
            <ion-icon [name]="message.role === 'user' ? 'people-outline' : 'document-text-outline'"></ion-icon>
          </ion-avatar>
        </div>
        <div class="message-content">
          <div class="message-text" [innerHTML]="formatMessage(message.content)"></div>
          <div class="message-time">{{ formatTime(message.timestamp) }}</div>
          <div class="message-actions">
            <ion-button 
              size="small" 
              fill="clear" 
              color="medium"
              (click)="copyToClipboard(message.content, $event)"
              title="Nachricht kopieren">
              <ion-icon name="copy-outline" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-button 
              *ngIf="message.role === 'user'"
              size="small" 
              fill="clear" 
              color="medium"
              [disabled]="isGenerating"
              (click)="resendMessage(message)"
              title="Re-send message">
              <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-button 
              *ngIf="message.role === 'user'"
              size="small" 
              fill="clear" 
              color="medium"
              [disabled]="isGenerating"
              (click)="editMessage(message)"
              title="Edit and resend from here">
              <ion-icon name="create-outline" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-button 
              *ngIf="message.role === 'assistant' && message.extractionType"
              size="small" 
              fill="outline" 
              color="primary"
              (click)="addToCodex(message)">
              <ion-icon name="add-outline" slot="start"></ion-icon>
              Add to Codex
            </ion-button>
          </div>
        </div>
      </div>
      
      <div *ngIf="isGenerating" class="message assistant-message">
        <div class="message-avatar">
          <ion-avatar>
            <ion-icon name="document-text-outline"></ion-icon>
          </ion-avatar>
        </div>
        <div class="message-content">
          <div class="message-text typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    </div>
  </ion-content>
  
  <ion-footer class="chat-footer" [class.keyboard-visible]="keyboardVisible">
    <div class="input-container">
      <ion-button *ngIf="isEditing"
                  (click)="cancelEdit()"
                  fill="clear"
                  size="small"
                  color="danger"
                  class="cancel-edit-button"
                  title="Cancel edit">
        <ion-icon name="close-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-textarea
        #messageInput
        [(ngModel)]="currentMessage"
        [placeholder]="isEditing ? 'Edit your previous messageâ€¦' : 'Ask a question about your scene...'"
        [autoGrow]="true"
        [rows]="1"
        (keydown.enter)="onEnterKey($any($event))"
        (ionFocus)="onInputFocus()"
        (ionBlur)="onInputBlur()"
        class="message-input">
      </ion-textarea>
      <ion-button 
        (click)="sendMessage()" 
        [disabled]="!currentMessage.trim() || isGenerating"
        fill="clear"
        class="send-button">
        <ion-icon [name]="isEditing ? 'create-outline' : 'send-outline'" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
  </ion-footer>
</div>

<!-- Codex Review Modal -->
<ion-modal 
  [isOpen]="showCodexReviewModal"
  [backdropDismiss]="!isSavingCodexEntries"
  (didDismiss)="handleCodexReviewDismiss()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Review Codex Entries</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="dismissCodexReviewModal()" [disabled]="isSavingCodexEntries">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <div class="codex-review-content" *ngIf="codexReviewEntries.length > 0; else codexReviewEmpty">
        <div class="codex-review-actions">
          <ion-button size="small" fill="clear" (click)="toggleSelectAllCodexEntries(true)" [disabled]="isSavingCodexEntries || areAllCodexEntriesSelected()">
            Select all
          </ion-button>
          <ion-button size="small" fill="clear" (click)="toggleSelectAllCodexEntries(false)" [disabled]="isSavingCodexEntries || getSelectedCodexEntriesCount() === 0">
            Clear
          </ion-button>
          <ion-button size="small"
                      color="primary"
                      fill="solid"
                      class="codex-review-confirm"
                      (click)="confirmCodexReviewAdd()"
                      [disabled]="isSavingCodexEntries || codexReviewEntries.length === 0">
            <ion-spinner slot="start" *ngIf="isSavingCodexEntries"></ion-spinner>
            Add Selected
          </ion-button>
        </div>
        <ion-list>
          <ion-item *ngFor="let entry of codexReviewEntries">
            <ion-checkbox 
              slot="start" 
              [(ngModel)]="entry.selected" 
              (ionChange)="onCodexEntrySelectionChanged()" 
              [disabled]="isSavingCodexEntries">
            </ion-checkbox>
            <ion-label>
              <div class="codex-entry-header">
                <h3>{{ entry.name }}</h3>
                <ion-chip *ngIf="entry.role" color="primary">{{ entry.role }}</ion-chip>
              </div>
              <div class="codex-entry-description" [innerHTML]="formatMessage(entry.description || 'No description provided.')"></div>
              <div class="codex-entry-fields" *ngIf="getFieldNamesForReview(entry).length > 0">
                <div class="codex-entry-field" *ngFor="let fieldName of getFieldNamesForReview(entry)">
                  <span class="field-name">{{ fieldName }}:</span>
                  <span class="field-value" [innerHTML]="formatMessage(entry.fields[fieldName])"></span>
                </div>
              </div>
              <div class="codex-entry-tags" *ngIf="entry.tags.length > 0">
                <ion-chip *ngFor="let tag of entry.tags" color="medium">{{ tag }}</ion-chip>
              </div>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>
      <ng-template #codexReviewEmpty>
        <div class="codex-review-empty">
          <p>No entries detected. Try running the extraction again.</p>
        </div>
      </ng-template>
    </ion-content>
    <ion-footer>
      <div class="codex-review-footer">
        <div class="codex-review-meta">
          <span>{{ getSelectedCodexEntriesCount() }} of {{ codexReviewEntries.length }} selected</span>
          <span *ngIf="codexReviewExtractionType">Category: {{ getExtractionTypeLabel(codexReviewExtractionType) }}</span>
        </div>
        <div class="codex-review-error" *ngIf="codexReviewError">{{ codexReviewError }}</div>
        <ion-button expand="block" (click)="confirmCodexReviewAdd()" [disabled]="isSavingCodexEntries || codexReviewEntries.length === 0">
          <ion-spinner slot="start" *ngIf="isSavingCodexEntries"></ion-spinner>
          Add to Codex
        </ion-button>
      </div>
    </ion-footer>
  </ng-template>
</ion-modal>

<!-- History List Modal -->
<ion-modal [isOpen]="showHistoryList" (didDismiss)="showHistoryList = false">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Chat Histories</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="showHistoryList = false">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <ion-list>
        <ion-item *ngFor="let h of histories" (click)="selectHistory(h)" [button]="true">
          <ion-icon name="time-outline" slot="start"></ion-icon>
          <ion-label>
            <h3>{{ getHistoryTitle(h) }}</h3>
            <p>{{ getHistoryMeta(h) }}</p>
          </ion-label>
        </ion-item>
        <ion-item *ngIf="histories.length === 0">
          <ion-label>No saved histories yet.</ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
   
</ion-modal>

<!-- Scene Selector Modal -->
<ion-modal [isOpen]="showSceneSelector" (didDismiss)="showSceneSelector = false">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Add Scenes as Context</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="showSceneSelector = false">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <ion-searchbar 
        [(ngModel)]="sceneSearchTerm" 
        placeholder="Search scenes..."
        animated="true">
      </ion-searchbar>
      
      <ion-list>
        <div *ngFor="let chapter of story?.chapters">
          <ion-item-divider>
            <ion-label>C{{ chapter.chapterNumber || chapter.order }}:{{ chapter.title }}</ion-label>
          </ion-item-divider>
          <ion-item 
            *ngFor="let scene of getFilteredScenes(chapter)" 
            [button]="true"
            (click)="toggleSceneSelection(chapter.id, scene.id)">
            <ion-checkbox 
              slot="start" 
              [checked]="isSceneSelected(scene.id)">
            </ion-checkbox>
            <ion-label>
              <h3>C{{ chapter.chapterNumber || chapter.order }}S{{ scene.sceneNumber || scene.order }}:{{ scene.title }}</h3>
              <p>{{ getScenePreview(scene) }}</p>
            </ion-label>
          </ion-item>
        </div>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Preset Prompts Modal -->
<ion-modal [isOpen]="showPresetPrompts" (didDismiss)="showPresetPrompts = false">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Predefined Prompts</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="showPresetPrompts = false">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <ion-list>
        <ion-item 
          *ngFor="let preset of presetPrompts" 
          [button]="true"
          (click)="usePresetPrompt(preset)">
          <ion-icon [name]="preset.icon" slot="start" [color]="getPresetColor(preset.extractionType)"></ion-icon>
          <ion-label>
            <h3>{{ preset.title }}</h3>
            <p>{{ preset.description }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>
