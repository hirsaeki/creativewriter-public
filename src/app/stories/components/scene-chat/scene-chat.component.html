<div class="ion-page">
  <app-header 
    title="Scene Chat" 
    [showBackButton]="true"
    [backAction]="goBack.bind(this)"
    [rightActions]="headerActions"
    [showSecondaryToolbar]="true"
    [secondaryContent]="modelToolbar">
  </app-header>
  
  <ng-template #modelToolbar>
    <div class="model-selection-container">
      <ng-select [(ngModel)]="selectedModel"
                 [items]="availableModels"
                 bindLabel="label"
                 bindValue="id"
                 [clearable]="false"
                 [searchable]="true"
                 placeholder="Select model..."
                 class="model-select"
                 appendTo="body">
        <ng-template ng-option-tmp let-item="item">
          <div class="model-option-inline">
            <ion-icon [name]="getProviderIcon(item.provider)" 
                      class="provider-icon-inline" 
                      [class.gemini]="item.provider === 'gemini'" 
                      [class.openrouter]="item.provider === 'openrouter'">
            </ion-icon>
            <span class="model-label">{{ item.label }}</span>
          </div>
        </ng-template>
      </ng-select>
    </div>
  </ng-template>
  
  <ion-content class="chat-content" [scrollEvents]="true">
    <div class="context-chips" *ngIf="selectedScenes.length > 0 || includeStoryOutline">
      <ion-chip *ngIf="includeStoryOutline" color="success">
        <ion-label>Story Overview</ion-label>
        <ion-icon 
          name="close-outline" 
          (click)="includeStoryOutline = false">
        </ion-icon>
      </ion-chip>
      <ion-chip *ngFor="let scene of selectedScenes" [color]="scene.sceneId === activeSceneId ? 'primary' : 'medium'">
        <ion-label>{{ scene.chapterTitle }} - {{ scene.sceneTitle }}</ion-label>
        <ion-icon 
          name="close-outline" 
          (click)="removeSceneContext(scene)">
        </ion-icon>
      </ion-chip>
    </div>

    <div class="chat-messages" #scrollContainer>
      <div *ngFor="let message of messages" 
           class="message" 
           [class.user-message]="message.role === 'user'"
           [class.assistant-message]="message.role === 'assistant'">
        <div class="message-avatar">
          <ion-avatar>
            <ion-icon [name]="message.role === 'user' ? 'people-outline' : 'document-text-outline'"></ion-icon>
          </ion-avatar>
        </div>
        <div class="message-content">
          <div class="message-text" [innerHTML]="formatMessage(message.content)"></div>
          <div class="message-time">{{ formatTime(message.timestamp) }}</div>
          <div class="message-actions">
            <ion-button 
              size="small" 
              fill="clear" 
              color="medium"
              (click)="copyToClipboard(message.content, $event)"
              title="Nachricht kopieren">
              <ion-icon name="copy-outline" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-button 
              *ngIf="message.role === 'assistant' && message.extractionType"
              size="small" 
              fill="outline" 
              color="primary"
              (click)="addToCodex(message)">
              <ion-icon name="add-outline" slot="start"></ion-icon>
              Add to Codex
            </ion-button>
          </div>
        </div>
      </div>
      
      <div *ngIf="isGenerating" class="message assistant-message">
        <div class="message-avatar">
          <ion-avatar>
            <ion-icon name="document-text-outline"></ion-icon>
          </ion-avatar>
        </div>
        <div class="message-content">
          <div class="message-text typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    </div>
  </ion-content>
  
  <ion-footer class="chat-footer" [class.keyboard-visible]="keyboardVisible">
    <div class="input-container">
      <ion-textarea
        #messageInput
        [(ngModel)]="currentMessage"
        placeholder="Ask a question about your scene..."
        [autoGrow]="true"
        [rows]="1"
        (keydown.enter)="onEnterKey($any($event))"
        (ionFocus)="onInputFocus()"
        (ionBlur)="onInputBlur()"
        class="message-input">
      </ion-textarea>
      <ion-button 
        (click)="sendMessage()" 
        [disabled]="!currentMessage.trim() || isGenerating"
        fill="clear"
        class="send-button">
        <ion-icon name="send-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
  </ion-footer>
</div>

<!-- Scene Selector Modal -->
<ion-modal [isOpen]="showSceneSelector" (didDismiss)="showSceneSelector = false">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Add Scenes as Context</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="showSceneSelector = false">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <ion-searchbar 
        [(ngModel)]="sceneSearchTerm" 
        placeholder="Search scenes..."
        animated="true">
      </ion-searchbar>
      
      <ion-list>
        <div *ngFor="let chapter of story?.chapters">
          <ion-item-divider>
            <ion-label>C{{ chapter.chapterNumber || chapter.order }}:{{ chapter.title }}</ion-label>
          </ion-item-divider>
          <ion-item 
            *ngFor="let scene of getFilteredScenes(chapter)" 
            [button]="true"
            (click)="toggleSceneSelection(chapter.id, scene.id)">
            <ion-checkbox 
              slot="start" 
              [checked]="isSceneSelected(scene.id)">
            </ion-checkbox>
            <ion-label>
              <h3>C{{ chapter.chapterNumber || chapter.order }}S{{ scene.sceneNumber || scene.order }}:{{ scene.title }}</h3>
              <p>{{ getScenePreview(scene) }}</p>
            </ion-label>
          </ion-item>
        </div>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Preset Prompts Modal -->
<ion-modal [isOpen]="showPresetPrompts" (didDismiss)="showPresetPrompts = false">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Predefined Prompts</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="showPresetPrompts = false">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <ion-list>
        <ion-item 
          *ngFor="let preset of presetPrompts" 
          [button]="true"
          (click)="usePresetPrompt(preset)">
          <ion-icon [name]="preset.icon" slot="start" [color]="getPresetColor(preset.extractionType)"></ion-icon>
          <ion-label>
            <h3>{{ preset.title }}</h3>
            <p>{{ preset.description }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>