<div class="ion-page">
  <ion-header>
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-back-button defaultHref="/"></ion-back-button>
      </ion-buttons>
      <ion-title>Mobile Debug Console</ion-title>
      <ion-buttons slot="end">
        <ion-button (click)="loadData()">
          <ion-icon name="refresh" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>

    <ion-toolbar>
      <ion-segment [(ngModel)]="activeTab" (ionChange)="loadData()" mode="md">
        <ion-segment-button value="crashes">
          <ion-label>Crashes<br><small>({{ crashLogs.length }})</small></ion-label>
        </ion-segment-button>
        <ion-segment-button value="metrics">
          <ion-label>Metrics</ion-label>
        </ion-segment-button>
        <ion-segment-button value="storage">
          <ion-label>Storage</ion-label>
        </ion-segment-button>
      </ion-segment>
    </ion-toolbar>
  </ion-header>

  <ion-content>
  <!-- Crashes Tab -->
  <div *ngIf="activeTab === 'crashes'">
    <div class="actions">
      <ion-button expand="block" fill="outline" (click)="exportLogs()">
        <ion-icon name="download" slot="start"></ion-icon>
        Export Logs
      </ion-button>
      <ion-button expand="block" fill="outline" (click)="copyToClipboard()">
        <ion-icon name="clipboard" slot="start"></ion-icon>
        Copy to Clipboard
      </ion-button>
      <ion-button expand="block" fill="outline" color="danger" (click)="clearLogs()">
        <ion-icon name="trash" slot="start"></ion-icon>
        Clear Logs
      </ion-button>
      <ion-button expand="block" fill="outline" color="warning" (click)="triggerTestCrash()">
        <ion-icon name="bug" slot="start"></ion-icon>
        Trigger Test Crash
      </ion-button>
    </div>

    <ion-card *ngIf="crashLogs.length === 0">
      <ion-card-content>
        <p class="ion-text-center">No crash logs recorded.</p>
      </ion-card-content>
    </ion-card>

    <ion-card *ngFor="let log of crashLogs; let i = index">
      <ion-card-header>
        <ion-card-subtitle>{{ formatDate(log.timestamp) }}</ion-card-subtitle>
        <ion-card-title class="error-title">{{ log.error }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngIf="log.stack">
            <ion-label class="ion-text-wrap">
              <p><strong>Stack Trace:</strong></p>
              <pre class="stack-trace">{{ log.stack }}</pre>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label class="ion-text-wrap">
              <p><strong>URL:</strong> {{ log.url }}</p>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="log.metrics.memory">
            <ion-label>
              <p><strong>Memory:</strong> {{ (log.metrics.memory.usedPercentage).toFixed(1) }}% used</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Metrics Tab -->
  <div *ngIf="activeTab === 'metrics' && currentMetrics">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Device Information</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>
              <p><strong>Platform:</strong> {{ currentMetrics.platform }}</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <p><strong>Viewport:</strong> {{ currentMetrics.viewport.width }}x{{ currentMetrics.viewport.height }}</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <p><strong>Orientation:</strong> {{ currentMetrics.orientation }}</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label class="ion-text-wrap">
              <p><strong>User Agent:</strong> {{ currentMetrics.userAgent }}</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <p><strong>Device Type:</strong>
                <ion-chip *ngIf="isIOS()" color="primary">iOS</ion-chip>
                <ion-chip *ngIf="isAndroid()" color="success">Android</ion-chip>
                <ion-chip *ngIf="!isIOS() && !isAndroid()">Desktop</ion-chip>
              </p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <ion-card *ngIf="currentMetrics.memory">
      <ion-card-header>
        <ion-card-title>Memory Usage (Live)</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="memory-display">
          <ion-progress-bar
            [value]="(currentMetrics.memory.usedPercentage || 0) / 100"
            [color]="getMemoryColor()">
          </ion-progress-bar>
          <p class="memory-stats">
            <strong>{{ (currentMetrics.memory.usedPercentage || 0).toFixed(1) }}%</strong>
            ({{ formatBytes(currentMetrics.memory.usedJSHeapSize) }} / {{ formatBytes(currentMetrics.memory.jsHeapSizeLimit) }})
          </p>
        </div>
        <ion-item>
          <ion-label class="ion-text-wrap">
            <p><strong>Used Heap:</strong> {{ formatBytes(currentMetrics.memory.usedJSHeapSize) }}</p>
            <p><strong>Total Heap:</strong> {{ formatBytes(currentMetrics.memory.totalJSHeapSize) }}</p>
            <p><strong>Heap Limit:</strong> {{ formatBytes(currentMetrics.memory.jsHeapSizeLimit) }}</p>
          </ion-label>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <ion-card *ngIf="!currentMetrics.memory">
      <ion-card-content>
        <p class="ion-text-center">Memory metrics not available on this browser.</p>
      </ion-card-content>
    </ion-card>

    <ion-card *ngIf="currentMetrics.connection">
      <ion-card-header>
        <ion-card-title>Network Information</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>
              <p><strong>Connection Type:</strong> {{ currentMetrics.connection.effectiveType || 'Unknown' }}</p>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="currentMetrics.connection.downlink">
            <ion-label>
              <p><strong>Downlink:</strong> {{ currentMetrics.connection.downlink }} Mbps</p>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="currentMetrics.connection.rtt">
            <ion-label>
              <p><strong>RTT:</strong> {{ currentMetrics.connection.rtt }} ms</p>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="currentMetrics.connection.saveData !== undefined">
            <ion-label>
              <p><strong>Data Saver:</strong> {{ currentMetrics.connection.saveData ? 'Enabled' : 'Disabled' }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Storage Tab -->
  <div *ngIf="activeTab === 'storage'">
    <ion-card *ngIf="crashLogs.length > 0 && crashLogs[0].localStorage">
      <ion-card-header>
        <ion-card-title>LocalStorage</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>
              <p><strong>Items:</strong> {{ crashLogs[0].localStorage.itemCount }}</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <p><strong>Estimated Size:</strong> {{ formatBytes(crashLogs[0].localStorage.estimatedSize) }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <ion-card *ngIf="crashLogs.length > 0 && crashLogs[0].indexedDB?.databases">
      <ion-card-header>
        <ion-card-title>IndexedDB Databases</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let db of crashLogs[0].indexedDB.databases">
            <ion-label class="ion-text-wrap">{{ db }}</ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Storage Info</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p class="ion-text-wrap">
          Mobile browsers have storage limits that vary by browser and device.
          If your app crashes frequently, try clearing old data or exporting important stories.
        </p>
        <ion-button expand="block" fill="outline" color="warning" routerLink="/settings">
          <ion-icon name="settings" slot="start"></ion-icon>
          Go to Settings
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>
  </ion-content>
</div>
