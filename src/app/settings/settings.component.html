<div class="ion-page">
  <app-header
    title="Settings"
    [showBackButton]="true"
    [backAction]="goBack.bind(this)"
    [rightActions]="headerActions">
  </app-header>

  <ion-content>
    <!-- Tab Navigation -->
    <app-settings-tabs
      [tabs]="tabItems"
      [(selectedTab)]="selectedTab">
    </app-settings-tabs>

    <app-settings-content>
      <!-- Tab Content -->
      <div [ngSwitch]="selectedTab">

        <!-- Models Tab -->
        <div *ngSwitchCase="'models'">
          <app-api-settings
            [settings]="settings"
            [combinedModels]="combinedModels"
            [replicateModels]="replicateModels"
            [loadingModels]="loadingModels"
            [modelLoadError]="modelLoadError"
            (settingsChange)="onSettingsChange()"
            (modelsLoaded)="onModelsLoaded($event)">
          </app-api-settings>
        </div>

        <!-- AI Favorites Tab -->
        <div *ngSwitchCase="'favorites'" class="favorites-tab">
          <div class="tab-header">
            <h2>AI Model Favorites</h2>
            <p>Configure quick-access models for different AI features</p>
          </div>

          <ion-accordion-group [multiple]="true" [value]="['beatInput']" class="favorites-accordion">
            <!-- Beat Input -->
            <ion-accordion value="beatInput">
              <ion-item slot="header" lines="full">
                <ion-icon name="create-outline" slot="start"></ion-icon>
                <ion-label>
                  <h3>Beat Input</h3>
                  <p>Quick-select models in the Beat AI panel</p>
                </ion-label>
                <ion-badge slot="end" color="primary">
                  {{ settings.favoriteModelLists?.beatInput?.length || 0 }}
                </ion-badge>
              </ion-item>
              <div slot="content" class="accordion-content">
                <app-model-favorites-settings
                  [favoriteIds]="settings.favoriteModelLists?.beatInput || []"
                  [combinedModels]="combinedModels"
                  [loadingModels]="loadingModels"
                  [modelLoadError]="modelLoadError"
                  [showCard]="false"
                  (favoriteIdsChange)="onFavoriteModelsChange('beatInput', $event)">
                </app-model-favorites-settings>
              </div>
            </ion-accordion>

            <!-- Scene Summary -->
            <ion-accordion value="sceneSummary">
              <ion-item slot="header" lines="full">
                <ion-icon name="document-text-outline" slot="start"></ion-icon>
                <ion-label>
                  <h3>Scene Summary</h3>
                  <p>Models for generating scene summaries</p>
                </ion-label>
                <ion-badge slot="end" color="primary">
                  {{ settings.favoriteModelLists?.sceneSummary?.length || 0 }}
                </ion-badge>
              </ion-item>
              <div slot="content" class="accordion-content">
                <app-model-favorites-settings
                  [favoriteIds]="settings.favoriteModelLists?.sceneSummary || []"
                  [combinedModels]="combinedModels"
                  [loadingModels]="loadingModels"
                  [modelLoadError]="modelLoadError"
                  [showCard]="false"
                  (favoriteIdsChange)="onFavoriteModelsChange('sceneSummary', $event)">
                </app-model-favorites-settings>
              </div>
            </ion-accordion>

            <!-- Rewrite -->
            <ion-accordion value="rewrite">
              <ion-item slot="header" lines="full">
                <ion-icon name="sync-outline" slot="start"></ion-icon>
                <ion-label>
                  <h3>Rewrite</h3>
                  <p>Models for text rewriting and editing</p>
                </ion-label>
                <ion-badge slot="end" color="primary">
                  {{ settings.favoriteModelLists?.rewrite?.length || 0 }}
                </ion-badge>
              </ion-item>
              <div slot="content" class="accordion-content">
                <app-model-favorites-settings
                  [favoriteIds]="settings.favoriteModelLists?.rewrite || []"
                  [combinedModels]="combinedModels"
                  [loadingModels]="loadingModels"
                  [modelLoadError]="modelLoadError"
                  [showCard]="false"
                  (favoriteIdsChange)="onFavoriteModelsChange('rewrite', $event)">
                </app-model-favorites-settings>
              </div>
            </ion-accordion>

            <!-- Character Chat -->
            <ion-accordion value="characterChat">
              <ion-item slot="header" lines="full">
                <ion-icon name="chatbubbles-outline" slot="start"></ion-icon>
                <ion-label>
                  <h3>Character Chat</h3>
                  <p>Models for character conversations</p>
                </ion-label>
                <ion-badge slot="end" color="primary">
                  {{ settings.favoriteModelLists?.characterChat?.length || 0 }}
                </ion-badge>
              </ion-item>
              <div slot="content" class="accordion-content">
                <app-model-favorites-settings
                  [favoriteIds]="settings.favoriteModelLists?.characterChat || []"
                  [combinedModels]="combinedModels"
                  [loadingModels]="loadingModels"
                  [modelLoadError]="modelLoadError"
                  [showCard]="false"
                  (favoriteIdsChange)="onFavoriteModelsChange('characterChat', $event)">
                </app-model-favorites-settings>
              </div>
            </ion-accordion>
          </ion-accordion-group>
        </div>

        <!-- Appearance Tab -->
        <div *ngSwitchCase="'appearance'">
          <app-ui-settings
            [settings]="settings"
            (settingsChange)="onSettingsChange()">
          </app-ui-settings>
        </div>

        <!-- AI Prompts Tab (consolidated) -->
        <div *ngSwitchCase="'ai-prompts'">
          <app-prompts-settings
            [settings]="settings"
            [combinedModels]="combinedModels"
            [loadingModels]="loadingModels"
            [modelLoadError]="modelLoadError"
            [modelsDisabled]="(!settings.openRouter.enabled || !settings.openRouter.apiKey) && (!settings.googleGemini.enabled || !settings.googleGemini.apiKey)"
            (settingsChange)="onSettingsChange()"
            (rewriteFavoritesChange)="onFavoriteModelsChange('rewrite', $event)">
          </app-prompts-settings>
        </div>

        <!-- Scene Generation Tab -->
        <div *ngSwitchCase="'scene-generation'">
          <app-scene-generation-settings
            [settings]="settings"
            [combinedModels]="combinedModels"
            [loadingModels]="loadingModels"
            [modelsDisabled]="(!settings.openRouter.enabled || !settings.openRouter.apiKey) && (!settings.googleGemini.enabled || !settings.googleGemini.apiKey)"
            (settingsChange)="onSettingsChange()">
          </app-scene-generation-settings>
        </div>

        <!-- Proxy Tab -->
        <div *ngSwitchCase="'proxy'">
          <app-proxy-settings
            (settingsChange)="onSettingsChange()">
          </app-proxy-settings>
        </div>

        <!-- Premium Tab -->
        <div *ngSwitchCase="'premium'">
          <app-premium-settings
            (settingsChange)="onSettingsChange()">
          </app-premium-settings>
        </div>

        <!-- Backup & Restore Tab -->
        <div *ngSwitchCase="'backup'">
          <app-database-maintenance></app-database-maintenance>

          <!-- Mobile Debug Console Link -->
          <div class="debug-link-container">
            <ion-button expand="block" fill="outline" color="medium" (click)="goToMobileDebug()">
              <ion-icon name="bug" slot="start"></ion-icon>
              Mobile Debug Console
            </ion-button>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="settings-actions">
        <ion-button expand="block" color="primary" (click)="saveSettings()" [disabled]="!hasUnsavedChanges">
          Save Settings
        </ion-button>
        <ion-button expand="block" fill="outline" color="medium" (click)="resetSettings()">
          Reset to Default
        </ion-button>
      </div>
    </app-settings-content>
  </ion-content>
</div>
